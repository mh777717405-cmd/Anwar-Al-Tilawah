<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الحلقات التعليمية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #25D366;
            --primary-dark: #128C7E;
            --secondary-color: #7209b7;
            --accent-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --success-color: #38b000;
            --info-color: #3a86ff;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 12px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
        }

        body {
            background-color: #f5f7ff;
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
        .p-2 { padding: 1rem; }
        .p-3 { padding: 1.5rem; }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.7rem 1.4rem;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            font-size: 1rem;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #2d9500; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #e11574; }
        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-warning:hover { background-color: #e68919; }
        .btn-light { background-color: var(--light-color); color: var(--dark-color); }
        .btn-light:hover { background-color: #e9ecef; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-info:hover { background-color: #2a75ff; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
        .btn-block { width: 100%; }
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-whatsapp:hover { background-color: #128C7E; }
        .btn-whatsapp-direct { background-color: #25D366; color: white; padding: 0.6rem 1.2rem; border-radius: 25px; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-whatsapp-direct:hover { background-color: #128C7E; transform: scale(1.05); }
        .btn-thaw { background-color: #3a86ff; color: white; }
        .btn-thaw:hover { background-color: #2667cc; }

        .form-group { margin-bottom: 1.2rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark-color); }
        .form-control { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius); font-size: 1rem; transition: var(--transition); background-color: white; }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2); }

        .phone-input-container { display: flex; align-items: center; gap: 0.5rem; }
        .country-code { background: #f8f9fa; padding: 0.8rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius); font-weight: 600; color: var(--dark-color); min-width: 100px; text-align: center; }
        .phone-input { flex: 1; }
        .password-container { position: relative; }
        .toggle-password { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-color); cursor: pointer; font-size: 1.1rem; }

        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 1rem; }
        .login-card { width: 100%; max-width: 420px; background-color: white; border-radius: var(--border-radius); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .login-header { background: linear-gradient(to right, var(--primary-color), var(--primary-dark)); color: white; padding: 2rem; text-align: center; }
        .login-title { font-size: 1.8rem; margin-bottom: 0.5rem; }
        .login-subtitle { opacity: 0.9; font-size: 1rem; }
        .login-body { padding: 2rem; }
        .login-footer { padding: 1.5rem 2rem; background-color: #f8f9fa; border-top: 1px solid var(--light-gray); text-align: center; }

        .footer { background-color: var(--dark-color); color: white; padding: 2rem 0; margin-top: auto; }
        .footer-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .footer-logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.2rem; font-weight: bold; }
        .developer-info { font-size: 0.95rem; color: #ccc; }

        .app-header { background-color: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; }
        .logo { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; color: var(--dark-color); }
        .logo-icon { color: var(--primary-color); font-size: 1.8rem; }
        .logo-text { font-size: 1.5rem; font-weight: 700; }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .user-info { display: flex; align-items: center; gap: 0.75rem; }
        .user-avatar { width: 42px; height: 42px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; }
        .user-name { font-weight: 600; }
        .user-role { font-size: 0.9rem; color: var(--gray-color); }
        .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.5rem; color: var(--dark-color); cursor: pointer; }

        .app-layout { display: flex; min-height: calc(100vh - 140px); }
        .sidebar { width: 260px; background-color: white; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05); padding: 1.5rem 0; transition: var(--transition); position: sticky; top: 80px; height: calc(100vh - 140px); overflow-y: auto; }
        .sidebar-nav { list-style: none; }
        .sidebar-item { margin-bottom: 0.25rem; }
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.9rem 1.5rem; color: var(--dark-color); text-decoration: none; transition: var(--transition); border-right: 4px solid transparent; }
        .sidebar-link:hover { background-color: rgba(37, 211, 102, 0.08); border-right-color: var(--primary-color); color: var(--primary-color); }
        .sidebar-link.active { background-color: rgba(37, 211, 102, 0.1); border-right-color: var(--primary-color); color: var(--primary-color); font-weight: 600; }
        .sidebar-icon { width: 20px; text-align: center; font-size: 1.1rem; }

        .main-content { flex: 1; padding: 2rem; overflow-y: auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .page-title { font-size: 1.8rem; color: var(--dark-color); display: flex; align-items: center; gap: 0.75rem; }
        .page-icon { color: var(--primary-color); font-size: 1.5rem; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; display: flex; align-items: center; gap: 1.5rem; transition: var(--transition); }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { width: 70px; height: 70px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; }
        .stat-icon.students { background: linear-gradient(135deg, #25D366, #128C7E); }
        .stat-icon.halaqas { background: linear-gradient(135deg, #7209b7, #5a08a5); }
        .stat-icon.present { background: linear-gradient(135deg, #38b000, #2d9500); }
        .stat-icon.absent { background: linear-gradient(135deg, #f72585, #e11574); }
        .stat-icon.frozen { background: linear-gradient(135deg, #6c757d, #495057); }
        .stat-icon.memorization { background: linear-gradient(135deg, #3a86ff, #2667cc); }

        .stat-info h3 { font-size: 2rem; margin-bottom: 0.25rem; }
        .stat-info p { color: var(--gray-color); font-size: 0.95rem; }

        .recent-activity { background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; }
        .activity-list { list-style: none; margin-top: 1rem; }
        .activity-item { display: flex; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 1rem; color: white; font-size: 1.1rem; }
        .activity-icon.present { background-color: var(--success-color); }
        .activity-icon.absent { background-color: var(--danger-color); }
        .activity-icon.added { background-color: var(--primary-color); }
        .activity-icon.edited { background-color: var(--warning-color); }
        .activity-icon.whatsapp { background-color: #25D366; }
        .activity-icon.frozen { background-color: #6c757d; }
        .activity-icon.thaw { background-color: #3a86ff; }
        .activity-icon.memorization { background-color: var(--info-color); }

        .activity-details p { margin-bottom: 0.25rem; }
        .activity-time { font-size: 0.85rem; color: var(--gray-color); }

        .table-responsive { overflow-x: auto; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
        .data-table { width: 100%; border-collapse: collapse; background-color: white; min-width: 800px; }
        .data-table th { background-color: rgba(37, 211, 102, 0.08); padding: 1rem; text-align: right; font-weight: 700; color: var(--dark-color); border-bottom: 1px solid var(--light-gray); }
        .data-table td { padding: 1rem; text-align: right; border-bottom: 1px solid var(--light-gray); }
        .data-table tbody tr:hover { background-color: rgba(37, 211, 102, 0.04); }
        .data-table tbody tr:last-child td { border-bottom: none; }

        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-present { background-color: rgba(56, 176, 0, 0.15); color: var(--success-color); }
        .status-absent { background-color: rgba(247, 37, 133, 0.15); color: var(--danger-color); }
        .status-not-recorded { background-color: rgba(108, 117, 125, 0.15); color: var(--gray-color); }
        .status-frozen { background-color: rgba(108, 117, 125, 0.3); color: var(--dark-color); border: 1px solid var(--gray-color); }

        .action-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        .attendance-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .attendance-filters { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .attendance-date { display: flex; align-items: center; gap: 0.5rem; }

        .report-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .report-content { background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; }
        .report-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--light-gray); }
        .report-title { font-size: 1.8rem; color: var(--dark-color); margin-bottom: 0.5rem; }
        .report-subtitle { color: var(--gray-color); font-size: 1.1rem; }
        .report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .summary-card { background: rgba(37, 211, 102, 0.05); border-radius: var(--border-radius); padding: 1.5rem; text-align: center; }
        .summary-card h4 { font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary-color); }
        .summary-card p { color: var(--gray-color); font-size: 0.95rem; }

        .memorization-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .memorization-card { background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; }
        .memorization-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-gray); }

        .progress-container { margin: 1rem 0; }
        .progress-bar { height: 10px; background-color: var(--light-gray); border-radius: 5px; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { height: 100%; background: linear-gradient(to right, var(--success-color), #2d9500); border-radius: 5px; transition: width 0.3s ease; }

        .modal-overlay { position: fixed; top: 0; right: 0; bottom: 0; left: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem; }
        .modal { background-color: white; border-radius: var(--border-radius); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2); width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: modalFadeIn 0.3s ease; }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--light-gray); }
        .modal-title { font-size: 1.4rem; color: var(--dark-color); margin: 0; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--gray-color); cursor: pointer; line-height: 1; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .modal-close:hover { background-color: var(--light-gray); color: var(--dark-color); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: flex-end; gap: 1rem; }

        .alert { padding: 1rem 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .alert-success { background-color: rgba(56, 176, 0, 0.1); color: var(--success-color); border: 1px solid rgba(56, 176, 0, 0.2); }
        .alert-danger { background-color: rgba(247, 37, 133, 0.1); color: var(--danger-color); border: 1px solid rgba(247, 37, 133, 0.2); }
        .alert-warning { background-color: rgba(248, 150, 30, 0.1); color: var(--warning-color); border: 1px solid rgba(248, 150, 30, 0.2); }
        .alert-info { background-color: rgba(37, 211, 102, 0.1); color: var(--primary-color); border: 1px solid rgba(37, 211, 102, 0.2); }

        .search-container { position: relative; max-width: 300px; }
        .search-input { padding-right: 2.5rem; }
        .search-icon { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--gray-color); }

        .whatsapp-message { background-color: #dcf8c6; border-radius: 18px; padding: 1rem; margin: 0.5rem 0; border: 1px solid #e6e6e6; max-width: 80%; margin-right: auto; }
        .whatsapp-container { background-color: #e5ddd5; padding: 1.5rem; border-radius: var(--border-radius); min-height: 300px; display: flex; flex-direction: column; }
        .whatsapp-header { background-color: #075e54; color: white; padding: 1rem; border-radius: var(--border-radius) var(--border-radius) 0 0; display: flex; align-items: center; gap: 0.75rem; }

        .whatsapp-card { background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 1.5rem; margin-bottom: 1rem; border: 2px solid #25D366; }
        .whatsapp-card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--light-gray); }
        .whatsapp-icon { color: #25D366; font-size: 1.5rem; }
        .whatsapp-info { flex: 1; }
        .whatsapp-message-preview { background-color: #f0f0f0; border-radius: 10px; padding: 1rem; margin: 1rem 0; white-space: pre-line; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .whatsapp-actions { display: flex; gap: 0.75rem; margin-top: 1rem; }

        .validation-hint { font-size: 0.85rem; color: var(--gray-color); margin-top: 0.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .validation-hint.valid { color: var(--success-color); }
        .validation-hint.invalid { color: var(--danger-color); }

        @media (max-width: 992px) {
            .sidebar { position: fixed; top: 80px; right: -260px; height: calc(100vh - 80px); z-index: 99; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); }
            .sidebar.active { right: 0; }
            .mobile-menu-btn { display: block; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .memorization-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 1rem; text-align: center; }
            .user-menu { width: 100%; justify-content: center; }
            .main-content { padding: 1.5rem; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .stats-grid { grid-template-columns: 1fr; }
            .attendance-controls, .report-controls { flex-direction: column; align-items: flex-start; }
            .attendance-filters { width: 100%; justify-content: space-between; }
            .footer-content { flex-direction: column; text-align: center; gap: 1rem; }
            .action-buttons { flex-direction: column; gap: 0.25rem; }
            .btn { padding: 0.6rem 1rem; font-size: 0.9rem; }
            .phone-input-container { flex-direction: column; align-items: flex-start; }
            .country-code { width: 100%; }
        }

        @media (max-width: 576px) {
            .login-card { max-width: 100%; }
            .modal { max-width: 100%; }
            .stat-card { flex-direction: column; text-align: center; gap: 1rem; }
            .stat-icon { width: 60px; height: 60px; font-size: 1.5rem; }
            .stat-info h3 { font-size: 1.6rem; }
        }

        .message-simulation { background-color: #e8f4fd; border-radius: var(--border-radius); padding: 1rem; margin: 1rem 0; border-right: 4px solid var(--accent-color); }
        .message-simulation p { margin-bottom: 0.5rem; }
        .message-simulation strong { color: var(--primary-color); }

        .absence-message { background-color: #fff8e1; border-radius: var(--border-radius); padding: 1.5rem; margin: 1rem 0; border: 1px solid #ffd54f; }

        .yemen-phone-notice { background-color: #e8f5e9; border-radius: var(--border-radius); padding: 1rem; margin: 0.5rem 0; border-right: 4px solid #25D366; }

        .frozen-card { background: linear-gradient(135deg, #f8f9fa, #e9ecef); border: 2px solid #6c757d; position: relative; }
        .frozen-badge { position: absolute; top: 10px; left: 10px; background-color: #6c757d; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }

        .progress-indicator { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
        .progress-text { font-size: 0.9rem; color: var(--gray-color); min-width: 80px; }
    </style>
</head>
<body>
    <!-- صفحة تسجيل الدخول -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">نظام إدارة الحلقات التعليمية</h1>
                <p class="login-subtitle">تسجيل دخول المعلمين</p>
            </div>
            
            <div class="login-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="username">اسم المستخدم</label>
                        <input type="text" id="username" class="form-control" placeholder="أدخل اسم المستخدم" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="password">كلمة المرور</label>
                        <div class="password-container">
                            <input type="password" id="password" class="form-control" placeholder="أدخل كلمة المرور" required>
                            <button type="button" class="toggle-password" id="togglePassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group mt-3">
                        <button type="submit" class="btn btn-block">
                            <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                        </button>
                    </div>
                    
                    <div id="loginMessage" class="alert alert-danger hidden">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="messageText"></span>
                    </div>
                </form>
            </div>
            
            <div class="login-footer">
                <p>ليس لديك حساب؟ <a href="#" id="showRegister">سجل كمدرس جديد</a></p>
            </div>
        </div>
    </div>

    <!-- صفحة التسجيل -->
    <div id="registerPage" class="login-container hidden">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">تسجيل معلم جديد</h1>
                <p class="login-subtitle">املأ البيانات لإنشاء حساب جديد</p>
            </div>
            
            <div class="login-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label" for="regFullName">الاسم الكامل</label>
                        <input type="text" id="regFullName" class="form-control" placeholder="أدخل الاسم الكامل" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="regUsername">اسم المستخدم</label>
                        <input type="text" id="regUsername" class="form-control" placeholder="أدخل اسم المستخدم" required>
                        <small class="text-muted">يجب أن يكون اسم المستخدم فريداً</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="regPassword">كلمة المرور</label>
                        <div class="password-container">
                            <input type="password" id="regPassword" class="form-control" placeholder="أدخل كلمة المرور" required>
                            <button type="button" class="toggle-password" id="toggleRegPassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">يجب أن تكون كلمة المرور 6 أحرف على الأقل</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="regConfirmPassword">تأكيد كلمة المرور</label>
                        <div class="password-container">
                            <input type="password" id="regConfirmPassword" class="form-control" placeholder="أكد كلمة المرور" required>
                            <button type="button" class="toggle-password" id="toggleRegConfirmPassword">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group mt-3">
                        <button type="submit" class="btn btn-block">
                            <i class="fas fa-user-plus"></i> إنشاء الحساب
                        </button>
                    </div>
                    
                    <div id="registerMessage" class="alert alert-danger hidden">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="registerMessageText"></span>
                    </div>
                </form>
            </div>
            
            <div class="login-footer">
                <p>لديك حساب بالفعل؟ <a href="#" id="showLogin">سجل الدخول</a></p>
            </div>
        </div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="app" class="hidden">
        <!-- الرأس -->
        <header class="app-header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="logo-text">نظام الحلقات - مركز أنوار التلاوة</div>
                    </div>
                    
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="user-menu">
                        <div class="user-info">
                            <div class="user-avatar" id="userAvatar">م</div>
                            <div>
                                <div class="user-name" id="currentUserName">المعلم</div>
                                <div class="user-role">معلم</div>
                            </div>
                        </div>
                        <button id="logoutBtn" class="btn btn-light btn-small">
                            <i class="fas fa-sign-out-alt"></i> خروج
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- المحتوى الرئيسي -->
        <div class="app-layout">
            <!-- القائمة الجانبية -->
            <nav class="sidebar" id="sidebar">
                <ul class="sidebar-nav">
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link active" data-page="dashboard">
                            <i class="fas fa-tachometer-alt sidebar-icon"></i>
                            <span>لوحة التحكم</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="halaqas">
                            <i class="fas fa-users sidebar-icon"></i>
                            <span>الحلقات</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="students">
                            <i class="fas fa-user-graduate sidebar-icon"></i>
                            <span>الطلاب</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="attendance">
                            <i class="fas fa-clipboard-check sidebar-icon"></i>
                            <span>تسجيل الحضور</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="memorization">
                            <i class="fas fa-book-quran sidebar-icon"></i>
                            <span>خطة التسميع</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="#" class="sidebar-link" data-page="reports">
                            <i class="fas fa-chart-bar sidebar-icon"></i>
                            <span>التقارير</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- المحتوى -->
            <main class="main-content" id="mainContent">
                <!-- لوحة التحكم -->
                <div id="dashboardPage" class="page">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-tachometer-alt page-icon"></i>
                            لوحة التحكم
                        </h1>
                        <div class="search-container">
                            <input type="text" id="dashboardSearch" class="form-control search-input" placeholder="بحث سريع...">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon students">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalStudents">0</h3>
                                <p>إجمالي الطلاب</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon halaqas">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalHalaqas">0</h3>
                                <p>إجمالي الحلقات</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon present">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="presentToday">0</h3>
                                <p>حضور اليوم</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon absent">
                                <i class="fas fa-user-times"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="absentToday">0</h3>
                                <p>غياب اليوم</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon frozen">
                                <i class="fas fa-snowflake"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="frozenStudents">0</h3>
                                <p>طلاب مجمدون</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon memorization">
                                <i class="fas fa-book-quran"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="memorizationProgress">0%</h3>
                                <p>متوسط التقدم</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recent-activity card">
                        <h2 class="mb-2">النشاطات الأخيرة</h2>
                        <ul class="activity-list" id="activityList">
                            <li class="activity-item">
                                <div class="activity-icon added">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <div class="activity-details">
                                    <p>مرحباً بك في نظام إدارة الحلقات التعليمية</p>
                                    <div class="activity-time">الآن</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- صفحة الحلقات -->
                <div id="halaqasPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-users page-icon"></i>
                            إدارة الحلقات
                        </h1>
                        <div>
                            <button id="addHalaqaBtn" class="btn">
                                <i class="fas fa-plus"></i> إضافة حلقة
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span>يمكنك إدارة الحلقات التعليمية الخاصة بك هنا. كل حلقة تحتوي على مجموعة من الطلاب.</span>
                    </div>
                    
                    <div class="card">
                        <div class="whatsapp-card">
                            <div class="whatsapp-card-header">
                                <div class="whatsapp-icon">
                                    <i class="fab fa-whatsapp"></i>
                                </div>
                                <div class="whatsapp-info">
                                    <h4 style="margin: 0;">إرسال إشعار غياب جماعي</h4>
                                    <p style="margin: 0; font-size: 0.9rem; color: var(--gray-color);">اختر التاريخ لإرسال رسالة جماعية للطلاب الغائبين</p>
                                </div>
                            </div>
                            
                            <form id="bulkAbsenceForm">
                                <div class="form-group">
                                    <label class="form-label" for="bulkAbsenceDate">تاريخ الغياب *</label>
                                    <input type="date" id="bulkAbsenceDate" class="form-control" required>
                                </div>
                                
                                <div class="form-group mt-2">
                                    <button type="button" id="checkAbsenceBtn" class="btn btn-info">
                                        <i class="fas fa-search"></i> فحص الغياب
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم الحلقة</th>
                                    <th>عدد الطلاب</th>
                                    <th>طلاب مجمدون</th>
                                    <th>تاريخ الإنشاء</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="halaqasTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- صفحة الطلاب -->
                <div id="studentsPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-user-graduate page-icon"></i>
                            إدارة الطلاب
                        </h1>
                        <div class="attendance-filters">
                            <div class="search-container">
                                <input type="text" id="searchStudents" class="form-control search-input" placeholder="بحث عن طالب...">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <button id="addStudentBtn" class="btn">
                                <i class="fas fa-plus"></i> إضافة طالب
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم الطالب</th>
                                    <th>رقم ولي الأمر</th>
                                    <th>الحلقة</th>
                                    <th>حالة العضوية</th>
                                    <th>أيام غياب متتالية</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- صفحة الحضور -->
                <div id="attendancePage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-clipboard-check page-icon"></i>
                            تسجيل الحضور
                        </h1>
                        <div class="attendance-controls">
                            <div class="attendance-filters">
                                <div class="attendance-date">
                                    <label for="attendanceDate" class="form-label">التاريخ:</label>
                                    <input type="date" id="attendanceDate" class="form-control">
                                </div>
                                <select id="halaqaFilter" class="form-control" style="min-width: 200px;">
                                    <option value="all">جميع الحلقات</option>
                                </select>
                                <label class="form-label">
                                    <input type="checkbox" id="showFrozenStudents" checked>
                                    إظهار الطلاب المجمدين
                                </label>
                            </div>
                            <div>
                                <button id="markAllPresentBtn" class="btn btn-success btn-small">
                                    <i class="fas fa-check"></i> تعيين الجميع حاضرين
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>عند تحديد طالب كـ "غائب" لمدة 3 أيام متتالية، سيتم إرسال رسالة تلقائية إلى ولي الأمر.</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم الطالب</th>
                                    <th>الحلقة</th>
                                    <th>رقم ولي الأمر</th>
                                    <th>حالة العضوية</th>
                                    <th>حالة الحضور</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button id="saveAttendanceBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ الحضور
                        </button>
                    </div>
                </div>

                <!-- صفحة خطة التسميع -->
                <div id="memorizationPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-book-quran page-icon"></i>
                            خطة التسميع والحفظ
                        </h1>
                        <div class="attendance-filters">
                            <select id="memorizationHalaqaFilter" class="form-control" style="min-width: 200px;">
                                <option value="all">جميع الحلقات</option>
                            </select>
                            <button id="addMemorizationBtn" class="btn">
                                <i class="fas fa-plus"></i> تسجيل تقدم
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span>تسجيل تقدم الطلاب في التسميع والحفظ. يمكنك إرسال تقرير فردي لكل طالب إلى ولي الأمر.</span>
                    </div>
                    
                    <div id="memorizationContent">
                        <div class="text-center mt-4">
                            <p class="text-muted">اختر حلقة لعرض تقدم الطلاب أو سجل تقدم جديد</p>
                        </div>
                    </div>
                </div>

                <!-- صفحة التقارير -->
                <div id="reportsPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">
                            <i class="fas fa-chart-bar page-icon"></i>
                            التقارير والإحصائيات
                        </h1>
                        <div class="report-controls">
                            <select id="reportType" class="form-control">
                                <option value="dailyAttendance">تقرير الحضور اليومي</option>
                                <option value="studentMemorization">تقارير التسميع الفردية</option>
                                <option value="absenceReport">تقرير الغياب المتواصل</option>
                            </select>
                            
                            <input type="date" id="reportDate" class="form-control">
                            
                            <select id="reportHalaqa" class="form-control">
                                <option value="all">جميع الحلقات</option>
                            </select>
                            
                            <button id="generateReportBtn" class="btn">
                                <i class="fas fa-chart-bar"></i> إنشاء التقرير
                            </button>
                            
                            <button id="printReportBtn" class="btn btn-light">
                                <i class="fas fa-print"></i> طباعة
                            </button>
                        </div>
                    </div>
                    
                    <div id="reportContent">
                        <div class="text-center mt-4">
                            <p class="text-muted">اختر نوع التقرير والتاريخ لبدء إنشاء التقارير</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- التذييل -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-logo">
                        <i class="fas fa-graduation-cap"></i>
                        <span>نظام إدارة الحلقات التعليمية</span>
                    </div>
                    <div class="developer-info">
                        <p>تم التطوير بواسطة: <strong>محمد عبدالله صالح الشليف</strong></p>
                        <p>جميع الحقوق محفوظة © <span id="currentYear"></span></p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- النوافذ المنبثقة -->
    
    <!-- نافذة إضافة حلقة -->
    <div id="addHalaqaModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">إضافة حلقة جديدة</h2>
                <button class="modal-close" id="closeHalaqaModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addHalaqaForm">
                    <div class="form-group">
                        <label class="form-label" for="halaqaName">اسم الحلقة *</label>
                        <input type="text" id="halaqaName" class="form-control" placeholder="مثال: حلقة القرآن الكريم" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="halaqaDescription">وصف الحلقة (اختياري)</label>
                        <textarea id="halaqaDescription" class="form-control" rows="3" placeholder="وصف مختصر للحلقة"></textarea>
                    </div>
                    
                    <div class="form-group mt-3">
                        <button type="submit" class="btn btn-block">إضافة الحلقة</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة طالب -->
    <div id="addStudentModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">إضافة طالب جديد</h2>
                <button class="modal-close" id="closeStudentModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div class="form-group">
                        <label class="form-label" for="studentName">اسم الطالب الكامل *</label>
                        <input type="text" id="studentName" class="form-control" placeholder="أدخل اسم الطالب" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="studentPhone">رقم هاتف ولي الأمر *</label>
                        <div class="phone-input-container">
                            <div class="country-code">+967</div>
                            <input type="tel" id="studentPhone" class="form-control phone-input" placeholder="7XXXXXXX" pattern="7[0-9]{8}" required>
                        </div>
                        <div class="validation-hint" id="phoneValidation">
                            <i class="fas fa-info-circle"></i>
                            <span>يجب أن يبدأ الرقم بـ 7 ويتكون من 9 أرقام (مثال: 712345678)</span>
                        </div>
                        <div class="yemen-phone-notice">
                            <i class="fas fa-flag"></i>
                            <span>يسمح فقط بالأرقام اليمنية (تبدأ بـ 7)</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="studentHalaqa">الحلقة *</label>
                        <select id="studentHalaqa" class="form-control" required>
                            <option value="">اختر الحلقة</option>
                        </select>
                    </div>
                    
                    <div class="form-group mt-3">
                        <button type="submit" class="btn btn-block">إضافة الطالب</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل الطالب -->
    <div id="editStudentModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">تعديل بيانات الطالب</h2>
                <button class="modal-close" id="closeEditStudentModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm">
                    <input type="hidden" id="editStudentId">
                    
                    <div class="form-group">
                        <label class="form-label" for="editStudentName">اسم الطالب الكامل *</label>
                        <input type="text" id="editStudentName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editStudentPhone">رقم هاتف ولي الأمر *</label>
                        <div class="phone-input-container">
                            <div class="country-code">+967</div>
                            <input type="tel" id="editStudentPhone" class="form-control phone-input" placeholder="7XXXXXXX" pattern="7[0-9]{8}" required>
                        </div>
                        <div class="validation-hint" id="editPhoneValidation">
                            <i class="fas fa-info-circle"></i>
                            <span>يجب أن يبدأ الرقم بـ 7 ويتكون من 9 أرقام (مثال: 712345678)</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="editStudentHalaqa">الحلقة *</label>
                        <select id="editStudentHalaqa" class="form-control" required>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="editStudentFrozen">
                            تجميد عضوية الطالب
                        </label>
                        <small class="text-muted">الطالب المجمد لن يظهر في تقارير الحضور اليومية</small>
                    </div>
                    
                    <div class="form-group mt-2">
                        <button type="button" class="btn btn-thaw btn-block" onclick="HalaqaSystem.unfreezeStudent(document.getElementById('editStudentId').value)">
                            <i class="fas fa-fire"></i> فك تجميد الطالب
                        </button>
                        <small class="text-muted">سيتم إلغاء تجميد الطالب فوراً</small>
                    </div>
                    
                    <div class="form-group mt-3">
                        <button type="submit" class="btn btn-block">حفظ التعديلات</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نافذة تسجيل تقدم التسميع -->
    <div id="addMemorizationModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">تسجيل تقدم التسميع</h2>
                <button class="modal-close" id="closeMemorizationModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addMemorizationForm">
                    <input type="hidden" id="memorizationStudentId">
                    
                    <div class="form-group">
                        <label class="form-label" for="memorizationStudentName">اسم الطالب</label>
                        <input type="text" id="memorizationStudentName" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="memorizationType">نوع التقدم *</label>
                        <select id="memorizationType" class="form-control" required>
                            <option value="">اختر نوع التقدم</option>
                            <option value="tajweed">تجويد</option>
                            <option value="memorization">حفظ</option>
                            <option value="revision">مراجعة</option>
                            <option value="recitation">تلاوة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="memorizationFrom">من (السورة/الجزء) *</label>
                        <input type="text" id="memorizationFrom" class="form-control" placeholder="مثال: سورة البقرة" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="memorizationTo">إلى (السورة/الجزء) *</label>
                        <input type="text" id="memorizationTo" class="form-control" placeholder="مثال: سورة آل عمران" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="memorizationNotes">ملاحظات (اختياري)</label>
                        <textarea id="memorizationNotes" class="form-control" rows="3" placeholder="ملاحظات عن التسميع"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="memorizationDate">تاريخ التسجيل *</label>
                        <input type="date" id="memorizationDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group mt-3">
                        <button type="submit" class="btn btn-block">حفظ التقدم</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- نافذة واتساب للغياب 3 أيام -->
    <div id="whatsappAbsence3DaysModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fab fa-whatsapp" style="color: #25D366;"></i>
                    إشعار غياب 3 أيام متتالية
                </h2>
                <button class="modal-close" id="closeWhatsapp3DaysModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="whatsapp-card">
                    <div class="whatsapp-card-header">
                        <div class="whatsapp-icon">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="whatsapp-info">
                            <h4 style="margin: 0;">إشعار غياب متواصل</h4>
                            <p style="margin: 0; font-size: 0.9rem; color: var(--gray-color);">غياب الطالب لمدة 3 أيام متتالية</p>
                        </div>
                    </div>
                    
                    <div class="absence-message">
                        <p><strong>الطالب:</strong> <span id="whatsapp3DaysStudentName"></span></p>
                        <p><strong>رقم ولي الأمر:</strong> <span id="whatsapp3DaysPhoneNumber"></span></p>
                        <p><strong>فترة الغياب:</strong> <span id="whatsapp3DaysAbsencePeriod"></span></p>
                        <p><strong>أيام الغياب:</strong> <span id="whatsapp3DaysAbsenceCount"></span> يوم متتالي</p>
                    </div>
                    
                    <div class="whatsapp-message-preview" id="whatsapp3DaysMessagePreview">
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>بعد إرسال هذه الرسالة، لن يظهر الطالب في التقارير اليومية حتى يعود للحضور.</span>
                    </div>
                    
                    <div class="modal-footer">
                        <a href="#" id="openWhatsapp3DaysBtn" class="btn btn-whatsapp-direct" target="_blank">
                            <i class="fab fa-whatsapp"></i> فتح واتساب وإرسال الرسالة
                        </a>
                        <button id="cancelWhatsapp3DaysBtn" class="btn btn-light">تجاهل الآن</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تقرير التسميع الفردي -->
    <div id="studentMemorizationReportModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">تقرير التسميع الفردي</h2>
                <button class="modal-close" id="closeStudentMemorizationModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-header" style="border-bottom: 1px solid var(--light-gray); padding-bottom: 1rem; margin-bottom: 1rem;">
                        <h3 id="memorizationReportStudentName" style="margin: 0;"></h3>
                        <p id="memorizationReportHalaqa" style="color: var(--gray-color); margin: 0.25rem 0 0 0;"></p>
                    </div>
                    
                    <div id="memorizationReportContent">
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        <span>يمكنك إرسال هذا التقرير إلى ولي أمر الطالب عبر واتساب.</span>
                    </div>
                    
                    <div class="modal-footer">
                        <a href="#" id="sendMemorizationReportBtn" class="btn btn-whatsapp-direct">
                            <i class="fab fa-whatsapp"></i> إرسال التقرير عبر واتساب
                        </a>
                        <button id="printMemorizationReportBtn" class="btn btn-light">
                            <i class="fas fa-print"></i> طباعة التقرير
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة الإرسال الجماعي -->
    <div id="bulkWhatsappModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fab fa-whatsapp" style="color: #25D366;"></i>
                    إرسال إشعار غياب جماعي
                </h2>
                <button class="modal-close" id="closeBulkModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="whatsapp-card">
                    <div class="whatsapp-card-header">
                        <div class="whatsapp-icon">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="whatsapp-info">
                            <h4 style="margin: 0;" id="bulkModalTitle">إرسال إشعار غياب</h4>
                            <p style="margin: 0; font-size: 0.9rem; color: var(--gray-color);" id="bulkModalSubtitle"></p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span>سيتم إرسال رسالة واحدة تحتوي على أسماء جميع الطلاب الغائبين إلى مجموعة الحلقة</span>
                    </div>
                    
                    <div class="row" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <div class="p-3" style="background-color: #f8f9fa; border-radius: 8px;">
                                <p><strong>الحلقة:</strong> <span id="bulkHalaqaName"></span></p>
                                <p><strong>التاريخ:</strong> <span id="bulkAbsenceDate"></span></p>
                                <p><strong>عدد الغائبين:</strong> <span id="bulkAbsenceCount">0</span> طالب</p>
                                <p><strong>عدد الحاضرين:</strong> <span id="bulkPresentCount">0</span> طالب</p>
                                <p><strong>نسبة الغياب:</strong> <span id="bulkAbsencePercentage">0%</span></p>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <div class="p-3" style="background-color: #fff8e1; border-radius: 8px; border: 1px solid #ffd54f;">
                                <h5><i class="fas fa-user-times text-warning"></i> الطلاب الغائبين:</h5>
                                <div id="bulkAbsentStudentsList" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="whatsapp-message-preview mt-3" id="bulkMessagePreview" style="background-color: #dcf8c6; border-radius: 10px; padding: 15px; border: 1px solid #e6e6e6;">
                    </div>
                    
                    <div class="message-simulation mt-3">
                        <h5><i class="fas fa-comment-dots"></i> كيف ستظهر الرسالة:</h5>
                        <div id="whatsappMessageSimulation" style="background-color: #e5ddd5; padding: 15px; border-radius: 10px;">
                            <div class="whatsapp-header" style="background-color: #075e54; color: white; padding: 10px; border-radius: 10px 10px 0 0; margin-bottom: 10px;">
                                <i class="fab fa-whatsapp"></i>
                                <span>مجموعة الحلقة</span>
                            </div>
                            <div class="whatsapp-message" id="whatsappMessageContent">
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button id="sendBulkToGroupBtn" class="btn btn-whatsapp-direct">
                            <i class="fab fa-whatsapp"></i> إرسال للمجموعة
                        </button>
                        <button id="sendBulkToParentsBtn" class="btn btn-whatsapp" style="background-color: #128C7E;">
                            <i class="fas fa-user-friends"></i> إرسال للأفراد
                        </button>
                        <button id="cancelBulkBtn" class="btn btn-light">إلغاء</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const HalaqaSystem = {
            currentUser: null,
            users: JSON.parse(localStorage.getItem('halaqa_users')) || [],
            halaqas: JSON.parse(localStorage.getItem('halaqas')) || [],
            students: JSON.parse(localStorage.getItem('students')) || [],
            attendance: JSON.parse(localStorage.getItem('attendance')) || [],
            memorization: JSON.parse(localStorage.getItem('memorization')) || [],
            activities: JSON.parse(localStorage.getItem('activities')) || [],
            
            init: function() {
                this.loadDefaultData();
                this.setupEventListeners();
                this.checkAuth();
                document.getElementById('currentYear').textContent = new Date().getFullYear();
                this.cleanupAttendance();
            },
            
            loadDefaultData: function() {
                if (this.users.length === 0) {
                    const defaultTeacher = {
                        id: 1,
                        fullName: "المعلم التجريبي",
                        username: "teacher",
                        password: "123456",
                        createdAt: new Date().toISOString()
                    };
                    this.users.push(defaultTeacher);
                    this.saveUsers();
                }
                
                if (this.halaqas.length === 0) {
                    const defaultHalaqas = [
                        { id: 1, teacherId: 1, name: "حلقة القرآن الكريم", description: "حفظ وتلاوة القرآن الكريم", createdAt: new Date().toISOString() },
                        { id: 2, teacherId: 1, name: "حلقة الفقه", description: "تعليم أحكام الفقه الإسلامي", createdAt: new Date().toISOString() }
                    ];
                    this.halaqas = defaultHalaqas;
                    this.saveHalaqas();
                }
                
                if (this.students.length === 0) {
                    const defaultStudents = [
                        { id: 1, name: "أحمد محمد علي", phone: "712345678", halaqaId: 1, teacherId: 1, isFrozen: false, createdAt: new Date().toISOString() },
                        { id: 2, name: "سارة خالد العتيبي", phone: "723456789", halaqaId: 1, teacherId: 1, isFrozen: false, createdAt: new Date().toISOString() },
                        { id: 3, name: "عمر عبدالله القحطاني", phone: "734567890", halaqaId: 2, teacherId: 1, isFrozen: false, createdAt: new Date().toISOString() },
                        { id: 4, name: "عبدالله محمد أحمد", phone: "745678901", halaqaId: 1, teacherId: 1, isFrozen: false, createdAt: new Date().toISOString() }
                    ];
                    this.students = defaultStudents;
                    this.saveStudents();
                }
                
                if (this.activities.length === 0) {
                    this.activities = [{ id: 1, type: "info", message: "تم إنشاء النظام بنجاح", timestamp: new Date().toISOString() }];
                    this.saveActivities();
                }
                
                if (this.memorization.length === 0) {
                    const defaultMemorization = [
                        { id: 1, studentId: 4, type: "memorization", from: "سورة البقرة", to: "سورة البقرة الآية 10", notes: "حفظ جيد", date: new Date().toISOString().split('T')[0], timestamp: new Date().toISOString() }
                    ];
                    this.memorization = defaultMemorization;
                    this.saveMemorization();
                }
            },
            
            saveUsers: function() { localStorage.setItem('halaqa_users', JSON.stringify(this.users)); },
            saveHalaqas: function() { localStorage.setItem('halaqas', JSON.stringify(this.halaqas)); },
            saveStudents: function() { localStorage.setItem('students', JSON.stringify(this.students)); },
            saveAttendance: function() { localStorage.setItem('attendance', JSON.stringify(this.attendance)); },
            saveMemorization: function() { localStorage.setItem('memorization', JSON.stringify(this.memorization)); },
            saveActivities: function() { localStorage.setItem('activities', JSON.stringify(this.activities)); },
            
            getArabicType: function(type) {
                switch(type) {
                    case 'tajweed': return 'تجويد';
                    case 'memorization': return 'حفظ';
                    case 'revision': return 'مراجعة';
                    case 'recitation': return 'تلاوة';
                    default: return type;
                }
            },
            
            validateYemeniPhone: function(phone) {
                return /^7[0-9]{8}$/.test(phone);
            },
            
            formatPhoneForDisplay: function(phone) {
                if (!phone) return '';
                return `+967 ${phone}`;
            },
            
            formatPhoneForWhatsapp: function(phone) {
                if (!phone) return '';
                return `967${phone}`;
            },
            
            createWhatsappLink: function(phone, message) {
                const formattedPhone = this.formatPhoneForWhatsapp(phone);
                const encodedMessage = encodeURIComponent(message);
                return `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            },
            
            createAbsenceMessage: function(studentName, date, halaqaName) {
                const today = new Date(date);
                const formattedDate = today.toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                return `السلام عليكم ورحمة الله وبركاته

أود إبلاغكم بأن الطالب/ة *${studentName}* كان غائباً عن ${halaqaName} بتاريخ ${formattedDate}.

نرجو منكم التواصل معنا لمعرفة سبب الغياب ومتابعة الطالب/ة.

تقبلوا تحياتنا
إدارة الحلقات التعليمية`;
            },
            
            create3DaysAbsenceMessage: function(studentName, startDate, endDate, halaqaName) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const formattedStart = start.toLocaleDateString('ar-SA');
                const formattedEnd = end.toLocaleDateString('ar-SA');
                
                return `السلام عليكم ورحمة الله وبركاته

نود إبلاغكم بأن الطالب/ة *${studentName}* كان غائباً عن ${halaqaName} لمدة *ثلاثة أيام متتالية* من ${formattedStart} إلى ${formattedEnd}.

نرجو منكم التواصل العاجل معنا لمعرفة سبب الغياب المتواصل واتخاذ الإجراءات اللازمة لمتابعة الطالب/ة.

لن يظهر الطالب/ة في التقارير اليومية حتى يعود للحضور.

تقبلوا تحياتنا
إدارة الحلقات التعليمية`;
            },
            
            createMemorizationReportMessage: function(studentName, halaqaName, progressData) {
                let message = `السلام عليكم ورحمة الله وبركاته

تقرير تقدم الطالب/ة *${studentName}* في ${halaqaName}

`;

                if (progressData.recentProgress && progressData.recentProgress.length > 0) {
                    message += `📖 *آخر التقدم المسجل:*\n`;
                    progressData.recentProgress.forEach(progress => {
                        const date = new Date(progress.date).toLocaleDateString('ar-SA');
                        message += `- ${this.getArabicType(progress.type)}: من ${progress.from} إلى ${progress.to}\n`;
                        message += `  التاريخ: ${date}\n`;
                        if (progress.notes) {
                            message += `  الملاحظات: ${progress.notes}\n`;
                        }
                        message += `\n`;
                    });
                }
                
                if (progressData.totalProgress) {
                    message += `📊 *إحصائيات التقدم:*\n`;
                    message += `- إجمالي المسجل: ${progressData.totalProgress.count} تسجيل\n`;
                    message += `- آخر تحديث: ${progressData.totalProgress.lastUpdate}\n`;
                }
                
                message += `

نتمنى لطالبنا/طالبتنا التوفيق والنجاح في حفظ كتاب الله تعالى.

تقبلوا تحياتنا
إدارة الحلقات التعليمية`;
                
                return message;
            },
            
            addActivity: function(type, message) {
                const activity = {
                    id: this.activities.length > 0 ? Math.max(...this.activities.map(a => a.id)) + 1 : 1,
                    type: type,
                    message: message,
                    timestamp: new Date().toISOString()
                };
                
                this.activities.unshift(activity);
                if (this.activities.length > 10) {
                    this.activities = this.activities.slice(0, 10);
                }
                this.saveActivities();
                this.updateActivityList();
            },
            
            getTimeAgo: function(timestamp) {
                const now = new Date();
                const past = new Date(timestamp);
                const diffMs = now - past;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'الآن';
                else if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
                else if (diffHours < 24) return `منذ ${diffHours} ساعة`;
                else if (diffDays < 7) return `منذ ${diffDays} يوم`;
                else return past.toLocaleDateString('ar-SA');
            },
            
            cleanupAttendance: function() {
                const studentIds = this.students.map(s => s.id);
                const beforeCount = this.attendance.length;
                this.attendance = this.attendance.filter(a => studentIds.includes(a.studentId));
                this.saveAttendance();
                const afterCount = this.attendance.length;
                const removed = beforeCount - afterCount;
                if (removed > 0) console.log(`تم تنظيف ${removed} سجل حضور لطلاب محذوفين`);
                return removed;
            },
            
            updateAllStats: function() {
                this.cleanupAttendance();
                const teacherStudents = this.getTeacherStudents();
                const totalStudents = teacherStudents.length;
                const totalHalaqas = this.getTeacherHalaqas().length;
                const frozenStudents = teacherStudents.filter(s => s.isFrozen).length;
                const today = new Date().toISOString().split('T')[0];
                const todayAttendance = this.getAttendanceByDate(today);
                const activeStudentIds = teacherStudents.filter(s => !s.isFrozen).map(s => s.id);
                const validTodayAttendance = todayAttendance.filter(a => activeStudentIds.includes(a.studentId));
                const presentToday = validTodayAttendance.filter(a => a.status === 'present').length;
                const absentToday = validTodayAttendance.filter(a => a.status === 'absent').length;
                const memorizationProgress = this.calculateMemorizationProgress();
                
                if (document.getElementById('totalStudents')) {
                    document.getElementById('totalStudents').textContent = totalStudents;
                    document.getElementById('totalHalaqas').textContent = totalHalaqas;
                    document.getElementById('presentToday').textContent = presentToday;
                    document.getElementById('absentToday').textContent = absentToday;
                    document.getElementById('frozenStudents').textContent = frozenStudents;
                    document.getElementById('memorizationProgress').textContent = memorizationProgress + '%';
                }
                
                this.check3DaysAbsence();
                
                return { totalStudents, totalHalaqas, presentToday, absentToday, frozenStudents, memorizationProgress };
            },
            
            calculateMemorizationProgress: function() {
                const teacherStudents = this.getTeacherStudents();
                if (teacherStudents.length === 0) return 0;
                
                let totalProgress = 0;
                let studentsWithProgress = 0;
                
                teacherStudents.forEach(student => {
                    const studentMemorization = this.memorization.filter(m => m.studentId === student.id);
                    if (studentMemorization.length > 0) {
                        const progress = Math.min(studentMemorization.length * 10, 100);
                        totalProgress += progress;
                        studentsWithProgress++;
                    }
                });
                
                if (studentsWithProgress === 0) return 0;
                return Math.round(totalProgress / studentsWithProgress);
            },
            
            checkAuth: function() {
                const currentUser = JSON.parse(localStorage.getItem('current_user'));
                if (currentUser) {
                    this.currentUser = currentUser;
                    this.showApp();
                    this.loadDashboard();
                } else {
                    this.showLogin();
                }
            },
            
            login: function(username, password) {
                const user = this.users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    this.currentUser = user;
                    localStorage.setItem('current_user', JSON.stringify(user));
                    this.addActivity('login', `تم تسجيل دخول ${user.fullName}`);
                    this.showApp();
                    this.loadDashboard();
                    return true;
                }
                return false;
            },
            
            logout: function() {
                this.addActivity('logout', `تم تسجيل خروج ${this.currentUser.fullName}`);
                this.currentUser = null;
                localStorage.removeItem('current_user');
                this.showLogin();
            },
            
            register: function(fullName, username, password) {
                if (this.users.find(u => u.username === username)) {
                    return { success: false, message: "اسم المستخدم موجود مسبقاً" };
                }
                
                const newUser = {
                    id: this.users.length > 0 ? Math.max(...this.users.map(u => u.id)) + 1 : 1,
                    fullName: fullName,
                    username: username,
                    password: password,
                    createdAt: new Date().toISOString()
                };
                
                this.users.push(newUser);
                this.saveUsers();
                this.addActivity('register', `تم تسجيل معلم جديد: ${fullName}`);
                return { success: true, user: newUser };
            },
            
            addHalaqa: function(name, description = '') {
                const newId = this.halaqas.length > 0 ? Math.max(...this.halaqas.map(h => h.id)) + 1 : 1;
                
                const halaqa = {
                    id: newId,
                    teacherId: this.currentUser.id,
                    name: name,
                    description: description,
                    createdAt: new Date().toISOString()
                };
                
                this.halaqas.push(halaqa);
                this.saveHalaqas();
                this.addActivity('added', `تم إضافة حلقة جديدة: ${name}`);
                this.updateAllStats();
                return halaqa;
            },
            
            deleteHalaqa: function(id) {
                const index = this.halaqas.findIndex(h => h.id === id);
                if (index !== -1) {
                    const halaqa = this.halaqas[index];
                    const studentsInHalaqa = this.students.filter(s => s.halaqaId === id);
                    
                    studentsInHalaqa.forEach(student => {
                        this.attendance = this.attendance.filter(a => a.studentId !== student.id);
                    });
                    this.saveAttendance();
                    
                    this.students = this.students.filter(s => s.halaqaId !== id);
                    this.saveStudents();
                    
                    studentsInHalaqa.forEach(student => {
                        this.memorization = this.memorization.filter(m => m.studentId !== student.id);
                    });
                    this.saveMemorization();
                    
                    this.halaqas.splice(index, 1);
                    this.saveHalaqas();
                    
                    this.addActivity('deleted', `تم حذف الحلقة: ${halaqa.name} مع ${studentsInHalaqa.length} طالب`);
                    this.updateAllStats();
                    
                    return { success: true, message: `تم حذف الحلقة "${halaqa.name}" و ${studentsInHalaqa.length} طالب` };
                }
                return { success: false, message: "الحلقة غير موجودة" };
            },
            
            addStudent: function(name, phone, halaqaId) {
                if (!this.validateYemeniPhone(phone)) {
                    return { success: false, message: "رقم الهاتف غير صحيح. يجب أن يكون رقم يمني يبدأ بـ 7 ويتكون من 9 أرقام" };
                }
                
                const newId = this.students.length > 0 ? Math.max(...this.students.map(s => s.id)) + 1 : 1;
                
                const student = {
                    id: newId,
                    name: name,
                    phone: phone,
                    halaqaId: parseInt(halaqaId),
                    teacherId: this.currentUser.id,
                    isFrozen: false,
                    createdAt: new Date().toISOString()
                };
                
                this.students.push(student);
                this.saveStudents();
                this.addActivity('added', `تم إضافة طالب جديد: ${name}`);
                this.updateAllStats();
                return { success: true, student: student };
            },
            
            updateStudent: function(id, name, phone, halaqaId, isFrozen = false) {
                if (!this.validateYemeniPhone(phone)) {
                    return { success: false, message: "رقم الهاتف غير صحيح. يجب أن يكون رقم يمني يبدأ بـ 7 ويتكون من 9 أرقام" };
                }
                
                const index = this.students.findIndex(s => s.id === id);
                if (index !== -1) {
                    const wasFrozen = this.students[index].isFrozen;
                    this.students[index].name = name;
                    this.students[index].phone = phone;
                    this.students[index].halaqaId = parseInt(halaqaId);
                    this.students[index].isFrozen = isFrozen;
                    this.saveStudents();
                    
                    if (wasFrozen !== isFrozen) {
                        const action = isFrozen ? 'تم تجميد عضوية' : 'تم تفعيل عضوية';
                        this.addActivity('frozen', `${action} الطالب: ${name}`);
                    } else {
                        this.addActivity('edited', `تم تعديل بيانات الطالب: ${name}`);
                    }
                    
                    this.updateAllStats();
                    return { success: true };
                }
                return { success: false, message: "الطالب غير موجود" };
            },
            
            unfreezeStudent: function(id) {
                const index = this.students.findIndex(s => s.id === id);
                if (index !== -1) {
                    const student = this.students[index];
                    student.isFrozen = false;
                    this.saveStudents();
                    
                    this.addActivity('thaw', `تم فك تجميد عضوية الطالب: ${student.name}`);
                    this.updateAllStats();
                    
                    this.loadStudentsPage();
                    this.showMessage('تم فك تجميد الطالب بنجاح', 'success');
                    return { success: true };
                }
                return { success: false, message: "الطالب غير موجود" };
            },
            
            deleteStudent: function(id) {
                const index = this.students.findIndex(s => s.id === id);
                if (index !== -1) {
                    const student = this.students[index];
                    
                    this.attendance = this.attendance.filter(a => a.studentId !== id);
                    this.saveAttendance();
                    
                    this.memorization = this.memorization.filter(m => m.studentId !== id);
                    this.saveMemorization();
                    
                    this.students.splice(index, 1);
                    this.saveStudents();
                    
                    this.addActivity('deleted', `تم حذف الطالب: ${student.name}`);
                    this.updateAllStats();
                    
                    return true;
                }
                return false;
            },
            
            markAttendance: function(studentId, date, status) {
                const student = this.students.find(s => s.id === parseInt(studentId));
                if (!student) {
                    console.error(`الطالب رقم ${studentId} غير موجود`);
                    return null;
                }
                
                if (student.isFrozen) {
                    this.showMessage('لا يمكن تسجيل حضور/غياب للطالب المجمد', 'warning');
                    return null;
                }
                
                const index = this.attendance.findIndex(a => a.studentId === parseInt(studentId) && a.date === date);
                
                const attendanceRecord = {
                    id: index !== -1 ? this.attendance[index].id : (this.attendance.length > 0 ? Math.max(...this.attendance.map(a => a.id)) + 1 : 1),
                    studentId: parseInt(studentId),
                    date: date,
                    status: status,
                    timestamp: new Date().toISOString()
                };
                
                if (index !== -1) {
                    this.attendance[index] = attendanceRecord;
                } else {
                    this.attendance.push(attendanceRecord);
                }
                
                this.saveAttendance();
                this.updateAllStats();
                
                if (status === 'absent') {
                    this.addActivity('absent', `تم تسجيل غياب للطالب: ${student.name}`);
                    this.checkStudent3DaysAbsence(parseInt(studentId));
                } else if (status === 'present') {
                    this.addActivity('present', `تم تسجيل حضور للطالب: ${student.name}`);
                }
                
                return attendanceRecord;
            },
            
            checkStudent3DaysAbsence: function(studentId) {
                const student = this.students.find(s => s.id === studentId);
                if (!student || student.isFrozen) return;
                
                const studentAttendance = this.getStudentAttendance(studentId)
                    .filter(a => a.status === 'absent')
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (studentAttendance.length < 3) return;
                
                const dates = studentAttendance.map(a => a.date);
                let consecutiveCount = 0;
                let lastDate = null;
                
                for (let i = dates.length - 1; i >= 0; i--) {
                    const currentDate = new Date(dates[i]);
                    
                    if (!lastDate) {
                        consecutiveCount = 1;
                        lastDate = currentDate;
                    } else {
                        const diffDays = Math.floor((lastDate - currentDate) / (1000 * 60 * 60 * 24));
                        if (diffDays === 1) {
                            consecutiveCount++;
                            lastDate = currentDate;
                        } else {
                            break;
                        }
                    }
                    
                    if (consecutiveCount >= 3) {
                        this.show3DaysAbsenceWarning(studentId, dates.slice(i, i + 3));
                        break;
                    }
                }
            },
            
            check3DaysAbsence: function() {
                const teacherStudents = this.getTeacherStudents().filter(s => !s.isFrozen);
                teacherStudents.forEach(student => {
                    this.checkStudent3DaysAbsence(student.id);
                });
            },
            
            show3DaysAbsenceWarning: function(studentId, absenceDates) {
                const student = this.students.find(s => s.id === studentId);
                if (!student) return;
                
                const halaqa = this.halaqas.find(h => h.id === student.halaqaId);
                const halaqaName = halaqa ? halaqa.name : 'الحلقة';
                
                document.getElementById('whatsapp3DaysStudentName').textContent = student.name;
                document.getElementById('whatsapp3DaysPhoneNumber').textContent = this.formatPhoneForDisplay(student.phone);
                document.getElementById('whatsapp3DaysAbsencePeriod').textContent = `${absenceDates[0]} إلى ${absenceDates[absenceDates.length - 1]}`;
                document.getElementById('whatsapp3DaysAbsenceCount').textContent = absenceDates.length;
                
                const message = this.create3DaysAbsenceMessage(student.name, absenceDates[0], absenceDates[absenceDates.length - 1], halaqaName);
                document.getElementById('whatsapp3DaysMessagePreview').textContent = message;
                
                const whatsappLink = this.createWhatsappLink(student.phone, message);
                document.getElementById('openWhatsapp3DaysBtn').href = whatsappLink;
                
                document.getElementById('openWhatsapp3DaysBtn').onclick = function(e) {
                    window.open(whatsappLink, '_blank');
                    setTimeout(() => {
                        document.getElementById('whatsappAbsence3DaysModal').classList.add('hidden');
                    }, 500);
                    
                    HalaqaSystem.addActivity('whatsapp', `تم إرسال إشعار غياب 3 أيام للطالب: ${student.name}`);
                    HalaqaSystem.updateStudent(student.id, student.name, student.phone, student.halaqaId, true);
                };
                
                document.getElementById('whatsappAbsence3DaysModal').classList.remove('hidden');
            },
            
            addMemorizationProgress: function(studentId, type, from, to, notes, date) {
                studentId = parseInt(studentId);
                
                const newId = this.memorization.length > 0 ? Math.max(...this.memorization.map(m => m.id)) + 1 : 1;
                
                const progress = {
                    id: newId,
                    studentId: studentId,
                    type: type,
                    from: from,
                    to: to,
                    notes: notes || '',
                    date: date,
                    timestamp: new Date().toISOString()
                };
                
                this.memorization.push(progress);
                this.saveMemorization();
                
                const student = this.students.find(s => s.id === studentId);
                if (student) {
                    this.addActivity('memorization', `تم تسجيل تقدم في التسميع للطالب: ${student.name}`);
                }
                
                this.updateAllStats();
                return { success: true, progress: progress };
            },
            
            getStudentMemorization: function(studentId) {
                return this.memorization.filter(m => m.studentId === studentId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
            },
            
            generateStudentMemorizationReport: function(studentId) {
                const student = this.students.find(s => s.id === studentId);
                if (!student) return null;
                
                const halaqa = this.halaqas.find(h => h.id === student.halaqaId);
                const memorizationData = this.getStudentMemorization(studentId);
                
                return {
                    student: student,
                    halaqa: halaqa,
                    memorization: memorizationData,
                    totalRecords: memorizationData.length,
                    lastUpdate: memorizationData.length > 0 ? new Date(memorizationData[0].date).toLocaleDateString('ar-SA') : 'لا يوجد'
                };
            },
            
            getTeacherHalaqas: function() {
                return this.halaqas.filter(h => h.teacherId === this.currentUser.id);
            },
            
            getTeacherStudents: function() {
                return this.students.filter(s => s.teacherId === this.currentUser.id);
            },
            
            getStudentAttendance: function(studentId, date = null) {
                if (date) {
                    return this.attendance.find(a => a.studentId === studentId && a.date === date);
                }
                return this.attendance.filter(a => a.studentId === studentId);
            },
            
            getConsecutiveAbsenceDays: function(studentId) {
                const studentAttendance = this.getStudentAttendance(studentId)
                    .filter(a => a.status === 'absent')
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (studentAttendance.length === 0) return 0;
                
                let consecutiveDays = 1;
                let lastDate = new Date(studentAttendance[0].date);
                
                for (let i = 1; i < studentAttendance.length; i++) {
                    const currentDate = new Date(studentAttendance[i].date);
                    const diffDays = Math.floor((lastDate - currentDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        consecutiveDays++;
                        lastDate = currentDate;
                    } else {
                        break;
                    }
                }
                
                return consecutiveDays;
            },
            
            getAttendanceByDate: function(date) {
                const currentStudentIds = this.getTeacherStudents().map(s => s.id);
                return this.attendance.filter(a => a.date === date && currentStudentIds.includes(a.studentId));
            },
            
            loadDashboard: function() {
                this.updateAllStats();
                this.updateActivityList();
            },
            
            updateActivityList: function() {
                const activityList = document.getElementById('activityList');
                if (!activityList) return;
                
                activityList.innerHTML = '';
                
                this.activities.forEach(activity => {
                    const timeAgo = this.getTimeAgo(activity.timestamp);
                    let iconClass = 'added';
                    let icon = 'fas fa-plus';
                    
                    if (activity.type === 'absent') { iconClass = 'absent'; icon = 'fas fa-user-times'; }
                    else if (activity.type === 'present') { iconClass = 'present'; icon = 'fas fa-check'; }
                    else if (activity.type === 'edited') { iconClass = 'edited'; icon = 'fas fa-edit'; }
                    else if (activity.type === 'deleted') { iconClass = 'absent'; icon = 'fas fa-trash'; }
                    else if (activity.type === 'login' || activity.type === 'logout') { iconClass = 'present'; icon = 'fas fa-sign-in-alt'; }
                    else if (activity.type === 'whatsapp') { iconClass = 'whatsapp'; icon = 'fab fa-whatsapp'; }
                    else if (activity.type === 'frozen') { iconClass = 'frozen'; icon = 'fas fa-snowflake'; }
                    else if (activity.type === 'thaw') { iconClass = 'thaw'; icon = 'fas fa-fire'; }
                    else if (activity.type === 'memorization') { iconClass = 'memorization'; icon = 'fas fa-book-quran'; }
                    
                    const activityItem = document.createElement('li');
                    activityItem.className = 'activity-item';
                    activityItem.innerHTML = `
                        <div class="activity-icon ${iconClass}">
                            <i class="${icon}"></i>
                        </div>
                        <div class="activity-details">
                            <p>${activity.message}</p>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    `;
                    
                    activityList.appendChild(activityItem);
                });
            },
            
            loadHalaqasPage: function() {
                const today = new Date().toISOString().split('T')[0];
                const bulkDateInput = document.getElementById('bulkAbsenceDate');
                if (bulkDateInput) bulkDateInput.value = today;
                this.loadHalaqasPageWithAbsence(today);
            },
            
            loadHalaqasPageWithAbsence: function(date) {
                const tableBody = document.getElementById('halaqasTableBody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                const teacherHalaqas = this.getTeacherHalaqas();
                const formattedDate = new Date(date).toLocaleDateString('ar-SA');
                
                if (teacherHalaqas.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="6" class="text-center"><p class="text-muted">لا توجد حلقات حتى الآن. ابدأ بإضافة حلقة جديدة.</p></td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                teacherHalaqas.forEach((halaqa, index) => {
                    const studentsInHalaqa = this.students.filter(s => s.halaqaId === halaqa.id);
                    const frozenStudents = studentsInHalaqa.filter(s => s.isFrozen).length;
                    const activeStudents = studentsInHalaqa.filter(s => !s.isFrozen);
                    const dateCreated = new Date(halaqa.createdAt).toLocaleDateString('ar-SA');
                    const absenceData = this.calculateHalaqaAbsence(halaqa.id, date);
                    const absentCount = absenceData.absentStudents.length;
                    const presentCount = absenceData.presentStudents.length;
                    const totalActive = activeStudents.length;
                    
                    let absenceBadge = '';
                    if (absentCount > 0) {
                        const percentage = totalActive > 0 ? Math.round((absentCount / totalActive) * 100) : 0;
                        absenceBadge = `<span class="status-badge status-absent" style="margin-left: 5px;">غياب: ${absentCount} (${percentage}%)</span>`;
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>
                            <div><strong>${halaqa.name}</strong></div>
                            <div style="font-size: 0.85rem; color: var(--gray-color);">${halaqa.description || 'لا يوجد وصف'}</div>
                            ${absenceBadge}
                        </td>
                        <td>${studentsInHalaqa.length}</td>
                        <td>${frozenStudents}</td>
                        <td>${dateCreated}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-small" onclick="HalaqaSystem.showBulkWhatsappModal(${halaqa.id})" ${absentCount === 0 ? 'disabled' : ''}>
                                    <i class="fab fa-whatsapp"></i> إرسال إشعار
                                </button>
                                <button class="btn btn-danger btn-small btn-icon" onclick="HalaqaSystem.deleteHalaqaHandler(${halaqa.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                const infoRow = document.createElement('tr');
                infoRow.innerHTML = `<td colspan="6" class="text-center" style="background-color: #f8f9fa;"><small class="text-muted">بيانات الغياب المعروضة بتاريخ: ${formattedDate}</small></td>`;
                tableBody.appendChild(infoRow);
            },
            
            calculateHalaqaAbsence: function(halaqaId, date) {
                const studentsInHalaqa = this.students.filter(s => s.halaqaId === halaqaId && !s.isFrozen);
                const attendanceData = this.getAttendanceByDate(date);
                
                const absentStudents = [];
                const presentStudents = [];
                
                studentsInHalaqa.forEach(student => {
                    const attendance = attendanceData.find(a => a.studentId === student.id);
                    
                    if (attendance) {
                        if (attendance.status === 'absent') absentStudents.push(student);
                        else if (attendance.status === 'present') presentStudents.push(student);
                    } else {
                        absentStudents.push(student);
                    }
                });
                
                return { absentStudents, presentStudents, totalStudents: studentsInHalaqa.length, attendanceRecorded: attendanceData.filter(a => studentsInHalaqa.some(s => s.id === a.studentId)).length };
            },
            
            loadStudentsPage: function() {
                const tableBody = document.getElementById('studentsTableBody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                const teacherStudents = this.getTeacherStudents();
                
                if (teacherStudents.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" class="text-center"><p class="text-muted">لا توجد طلاب حتى الآن. ابدأ بإضافة طالب جديد.</p></td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                teacherStudents.forEach((student, index) => {
                    const halaqa = this.halaqas.find(h => h.id === student.halaqaId);
                    const halaqaName = halaqa ? halaqa.name : 'غير محدد';
                    const consecutiveAbsence = this.getConsecutiveAbsenceDays(student.id);
                    
                    let statusBadge = '';
                    if (student.isFrozen) statusBadge = '<span class="status-badge status-frozen">مجمد</span>';
                    else statusBadge = '<span class="status-badge status-present">نشط</span>';
                    
                    let absenceWarning = '';
                    if (consecutiveAbsence >= 3) absenceWarning = `<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${consecutiveAbsence} أيام</span>`;
                    else if (consecutiveAbsence > 0) absenceWarning = `${consecutiveAbsence} يوم`;
                    else absenceWarning = 'لا يوجد';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td><strong>${student.name}</strong></td>
                        <td>${this.formatPhoneForDisplay(student.phone)}</td>
                        <td>${halaqaName}</td>
                        <td>${statusBadge}</td>
                        <td>${absenceWarning}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-small btn-icon" onclick="HalaqaSystem.editStudentHandler(${student.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${student.isFrozen ? `
                                    <button class="btn btn-thaw btn-small btn-icon" onclick="HalaqaSystem.unfreezeStudent(${student.id})" title="فك التجميد">
                                        <i class="fas fa-fire"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-danger btn-small btn-icon" onclick="HalaqaSystem.deleteStudentHandler(${student.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-info btn-small btn-icon" onclick="HalaqaSystem.showMemorizationReport(${student.id})">
                                    <i class="fas fa-book-quran"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            },
            
            loadAttendancePage: function() {
                const tableBody = document.getElementById('attendanceTableBody');
                const halaqaFilter = document.getElementById('halaqaFilter');
                const attendanceDate = document.getElementById('attendanceDate');
                const showFrozen = document.getElementById('showFrozenStudents');
                
                if (!tableBody || !halaqaFilter || !attendanceDate) return;
                
                const today = new Date().toISOString().split('T')[0];
                if (!attendanceDate.value) attendanceDate.value = today;
                
                halaqaFilter.innerHTML = '<option value="all">جميع الحلقات</option>';
                this.getTeacherHalaqas().forEach(halaqa => {
                    const option = document.createElement('option');
                    option.value = halaqa.id;
                    option.textContent = halaqa.name;
                    halaqaFilter.appendChild(option);
                });
                
                let students = this.getTeacherStudents();
                const selectedHalaqa = halaqaFilter.value;
                if (selectedHalaqa !== 'all') {
                    students = students.filter(s => s.halaqaId === parseInt(selectedHalaqa));
                }
                
                if (!showFrozen.checked) {
                    students = students.filter(s => !s.isFrozen);
                }
                
                tableBody.innerHTML = '';
                
                if (students.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" class="text-center"><p class="text-muted">لا توجد طلاب في هذه الحلقة.</p></td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                const date = attendanceDate.value;
                const existingAttendance = this.getAttendanceByDate(date);
                
                students.forEach((student, index) => {
                    const halaqa = this.halaqas.find(h => h.id === student.halaqaId);
                    const halaqaName = halaqa ? halaqa.name : 'غير محدد';
                    const currentAttendance = existingAttendance.find(a => a.studentId === student.id);
                    const currentStatus = currentAttendance ? currentAttendance.status : 'not-recorded';
                    
                    let statusBadge = '';
                    if (currentStatus === 'present') statusBadge = '<span class="status-badge status-present">حاضر</span>';
                    else if (currentStatus === 'absent') statusBadge = '<span class="status-badge status-absent">غائب</span>';
                    else statusBadge = '<span class="status-badge status-not-recorded">لم يسجل</span>';
                    
                    let membershipBadge = '';
                    if (student.isFrozen) membershipBadge = '<span class="status-badge status-frozen">مجمد</span>';
                    else membershipBadge = '<span class="status-badge status-present">نشط</span>';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td><strong>${student.name}</strong></td>
                        <td>${halaqaName}</td>
                        <td>${this.formatPhoneForDisplay(student.phone)}</td>
                        <td>${membershipBadge}</td>
                        <td id="status-${student.id}">${statusBadge}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-small" onclick="HalaqaSystem.markStudentAttendance(${student.id}, 'present')" ${student.isFrozen ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i> حاضر
                                </button>
                                <button class="btn btn-danger btn-small" onclick="HalaqaSystem.markStudentAttendance(${student.id}, 'absent')" ${student.isFrozen ? 'disabled' : ''}>
                                    <i class="fas fa-times"></i> غائب
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            },
            
            loadMemorizationPage: function() {
                const memorizationContent = document.getElementById('memorizationContent');
                const halaqaFilter = document.getElementById('memorizationHalaqaFilter');
                
                if (!memorizationContent || !halaqaFilter) return;
                
                halaqaFilter.innerHTML = '<option value="all">جميع الحلقات</option>';
                this.getTeacherHalaqas().forEach(halaqa => {
                    const option = document.createElement('option');
                    option.value = halaqa.id;
                    option.textContent = halaqa.name;
                    halaqaFilter.appendChild(option);
                });
                
                this.loadMemorizationStudents('all');
            },
            
            loadMemorizationStudents: function(halaqaId) {
                const memorizationContent = document.getElementById('memorizationContent');
                if (!memorizationContent) return;
                
                let students = this.getTeacherStudents();
                if (halaqaId !== 'all') students = students.filter(s => s.halaqaId === parseInt(halaqaId));
                
                if (students.length === 0) {
                    memorizationContent.innerHTML = `<div class="text-center mt-4"><p class="text-muted">لا توجد طلاب في هذه الحلقة.</p></div>`;
                    return;
                }
                
                let html = '<div class="memorization-grid">';
                
                students.forEach(student => {
                    const halaqa = this.halaqas.find(h => h.id === student.halaqaId);
                    const halaqaName = halaqa ? halaqa.name : 'غير محدد';
                    const memorizationData = this.getStudentMemorization(student.id);
                    const lastProgress = memorizationData.length > 0 ? memorizationData[0] : null;
                    
                    html += `
                        <div class="memorization-card ${student.isFrozen ? 'frozen-card' : ''}">
                            ${student.isFrozen ? '<div class="frozen-badge">مجمد</div>' : ''}
                            <div class="memorization-card-header">
                                <div>
                                    <h3 style="margin: 0;">${student.name}</h3>
                                    <p style="margin: 0; color: var(--gray-color); font-size: 0.9rem;">${halaqaName}</p>
                                </div>
                                <div>
                                    <button class="btn btn-small btn-info" onclick="HalaqaSystem.addMemorizationProgressHandler(${student.id})">
                                        <i class="fas fa-plus"></i> تسجيل
                                    </button>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-indicator">
                                    <span class="progress-text">التقدم:</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${Math.min(memorizationData.length * 10, 100)}%"></div>
                                    </div>
                                    <span>${Math.min(memorizationData.length * 10, 100)}%</span>
                                </div>
                            </div>
                            
                            ${lastProgress ? `
                                <div class="mt-2">
                                    <p style="margin: 0;"><strong>آخر تقدم:</strong> ${this.getArabicType(lastProgress.type)}</p>
                                    <p style="margin: 0; font-size: 0.9rem;">من ${lastProgress.from} إلى ${lastProgress.to}</p>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--gray-color);">
                                        ${new Date(lastProgress.date).toLocaleDateString('ar-SA')}
                                    </p>
                                </div>
                            ` : `
                                <div class="text-center mt-2">
                                    <p class="text-muted">لا يوجد تقدم مسجل</p>
                                </div>
                            `}
                            
                            <div class="mt-3">
                                <button class="btn btn-block btn-light" onclick="HalaqaSystem.showMemorizationReport(${student.id})">
                                    <i class="fas fa-file-alt"></i> عرض التقرير
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                memorizationContent.innerHTML = html;
            },
            
            checkAllHalaqasAbsence: function() {
                const date = document.getElementById('bulkAbsenceDate').value;
                if (!date) {
                    this.showMessage('الرجاء اختيار تاريخ', 'warning');
                    return;
                }
                
                this.loadHalaqasPageWithAbsence(date);
                this.showMessage(`تم فحص الغياب لجميع الحلقات بتاريخ ${new Date(date).toLocaleDateString('ar-SA')}`, 'success');
            },
            
            createBulkAbsenceMessage: function(halaqa, absentStudents, date) {
                const formattedDate = new Date(date).toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                let studentsList = '';
                absentStudents.forEach((student, index) => {
                    studentsList += `${index + 1}. ${student.name}\n`;
                });
                
                const message = `📢 *إشعار غياب - ${halaqa.name}*

التاريخ: ${formattedDate}

🎓 *الطلاب الغائبين:*
${studentsList}

📊 *إحصائيات:*
- عدد الغائبين: ${absentStudents.length} طالب
- تم تسجيل الحضور لـ ${halaqa.totalStudents - absentStudents.length} طالب

🗓️ *التذكير:*
• الغياب لمدة 3 أيام متتالية يستدعي التواصل مع الإدارة
• يُرجى إبلاغنا بأسباب الغياب للمتابعة

📞 للاستفسار:
يمكنكم التواصل مع إدارة الحلقة

*نتمنى للجميع التوفيق والنجاح*
*إدارة الحلقات التعليمية*`;

                return message;
            },
            
            showBulkWhatsappModal: function(halaqaId) {
                const date = document.getElementById('bulkAbsenceDate').value;
                if (!date) {
                    this.showMessage('الرجاء اختيار تاريخ أولاً', 'warning');
                    return;
                }
                
                const halaqa = this.halaqas.find(h => h.id === halaqaId);
                if (!halaqa) return;
                
                const absenceData = this.calculateHalaqaAbsence(halaqaId, date);
                const absentStudents = absenceData.absentStudents;
                const presentStudents = absenceData.presentStudents;
                const totalActive = absenceData.totalStudents;
                
                if (absentStudents.length === 0) {
                    this.showMessage('لا يوجد طلاب غائبين في هذه الحلقة لهذا التاريخ', 'info');
                    return;
                }
                
                document.getElementById('bulkModalTitle').textContent = `إشعار غياب - ${halaqa.name}`;
                document.getElementById('bulkModalSubtitle').textContent = `إرسال إشعار جماعي للطلاب الغائبين`;
                document.getElementById('bulkHalaqaName').textContent = halaqa.name;
                document.getElementById('bulkAbsenceDate').textContent = new Date(date).toLocaleDateString('ar-SA');
                document.getElementById('bulkAbsenceCount').textContent = absentStudents.length;
                document.getElementById('bulkPresentCount').textContent = presentStudents.length;
                
                const absencePercentage = totalActive > 0 ? Math.round((absentStudents.length / totalActive) * 100) : 0;
                document.getElementById('bulkAbsencePercentage').textContent = `${absencePercentage}%`;
                
                const studentsList = document.getElementById('bulkAbsentStudentsList');
                studentsList.innerHTML = '';
                
                absentStudents.forEach(student => {
                    const studentItem = document.createElement('div');
                    studentItem.className = 'p-1';
                    studentItem.style.borderBottom = '1px solid #eee';
                    studentItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${student.name}</span>
                            <small class="text-muted">${this.formatPhoneForDisplay(student.phone)}</small>
                        </div>
                    `;
                    studentsList.appendChild(studentItem);
                });
                
                const message = this.createBulkAbsenceMessage({ ...halaqa, totalStudents: totalActive }, absentStudents, date);
                
                document.getElementById('bulkMessagePreview').innerHTML = `<div style="white-space: pre-line; font-family: 'Segoe UI', sans-serif;">${message}</div>`;
                document.getElementById('whatsappMessageContent').innerHTML = `<div style="white-space: pre-line; background-color: white; padding: 10px; border-radius: 5px; max-width: 80%; margin: 0 auto;">${message}</div>`;
                
                const sendData = { halaqaId: halaqaId, halaqaName: halaqa.name, date: date, absentStudents: absentStudents, message: message, formattedDate: new Date(date).toLocaleDateString('ar-SA') };
                sessionStorage.setItem('bulkSendData', JSON.stringify(sendData));
                
                document.getElementById('bulkWhatsappModal').classList.remove('hidden');
            },
            
            sendBulkToGroup: function() {
                const sendData = JSON.parse(sessionStorage.getItem('bulkSendData'));
                if (!sendData) return;
                
                const groupPhone = "1234567890";
                const whatsappLink = this.createWhatsappLink(groupPhone, sendData.message);
                window.open(whatsappLink, '_blank');
                
                this.showMessage(`تم فتح واتساب لإرسال الرسالة إلى مجموعة ${sendData.halaqaName}`, 'success');
                this.addActivity('whatsapp', `تم إرسال إشعار غياب جماعي لمجموعة ${sendData.halaqaName} - ${sendData.absentStudents.length} طالب غائب`);
                document.getElementById('bulkWhatsappModal').classList.add('hidden');
            },
            
            sendBulkToParents: function() {
                const sendData = JSON.parse(sessionStorage.getItem('bulkSendData'));
                if (!sendData) return;
                
                const { absentStudents, halaqaName, formattedDate } = sendData;
                
                absentStudents.forEach((student, index) => {
                    setTimeout(() => {
                        const individualMessage = `السلام عليكم ورحمة الله وبركاته

نود إبلاغكم بأن الطالب/ة *${student.name}* كان غائباً عن حلقة *${halaqaName}* بتاريخ ${formattedDate}.

يرجى التواصل مع إدارة الحلقة لمعرفة سبب الغياب ومتابعة الطالب/ة.

تقبلوا تحياتنا
إدارة الحلقات التعليمية`;
                        
                        const whatsappLink = this.createWhatsappLink(student.phone, individualMessage);
                        window.open(whatsappLink, '_blank');
                        
                    }, index * 1500);
                });
                
                this.showMessage(`جارٍ إرسال ${absentStudents.length} رسالة فردية لأولياء الأمور...`, 'info');
                this.addActivity('whatsapp', `تم إرسال إشعار غياب فردي لـ ${absentStudents.length} ولي أمر في حلقة ${halaqaName}`);
                document.getElementById('bulkWhatsappModal').classList.add('hidden');
            },
            
            markStudentAttendance: function(studentId, status) {
                const date = document.getElementById('attendanceDate').value;
                const result = this.markAttendance(studentId, date, status);
                
                if (result) {
                    let statusText = status === 'present' ? 'حاضر' : 'غائب';
                    let statusClass = status === 'present' ? 'status-present' : 'status-absent';
                    
                    const statusElement = document.getElementById(`status-${studentId}`);
                    if (statusElement) statusElement.innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;
                    this.showMessage(`تم تسجيل ${statusText} للطالب بنجاح`, 'success');
                }
            },
            
            deleteHalaqaHandler: function(halaqaId) {
                if (confirm('تحذير: سيتم حذف الحلقة وجميع طلابها وسجلات حضورهم. هل أنت متأكد؟')) {
                    const result = this.deleteHalaqa(halaqaId);
                    if (result.success) {
                        this.loadHalaqasPage();
                        this.showMessage(result.message, 'success');
                    } else this.showMessage(result.message, 'danger');
                }
            },
            
            deleteStudentHandler: function(studentId) {
                if (confirm('هل أنت متأكد من حذف هذا الطالب؟ سيتم حذف جميع سجلات حضوره أيضاً.')) {
                    const success = this.deleteStudent(studentId);
                    if (success) {
                        this.loadStudentsPage();
                        this.showMessage('تم حذف الطالب وتحديث الإحصائيات', 'success');
                    } else this.showMessage('حدث خطأ أثناء حذف الطالب', 'danger');
                }
            },
            
            editStudentHandler: function(studentId) {
                const student = this.students.find(s => s.id === studentId);
                if (!student) return;
                
                document.getElementById('editStudentId').value = studentId;
                document.getElementById('editStudentName').value = student.name;
                document.getElementById('editStudentPhone').value = student.phone;
                document.getElementById('editStudentFrozen').checked = student.isFrozen;
                
                const halaqaSelect = document.getElementById('editStudentHalaqa');
                halaqaSelect.innerHTML = '';
                
                this.getTeacherHalaqas().forEach(halaqa => {
                    const option = document.createElement('option');
                    option.value = halaqa.id;
                    option.textContent = halaqa.name;
                    if (halaqa.id === student.halaqaId) option.selected = true;
                    halaqaSelect.appendChild(option);
                });
                
                document.getElementById('editStudentModal').classList.remove('hidden');
            },
            
            addMemorizationProgressHandler: function(studentId) {
                const student = this.students.find(s => s.id === studentId);
                if (!student) {
                    this.showMessage('الطالب غير موجود', 'danger');
                    return;
                }
                
                document.getElementById('memorizationStudentId').value = studentId;
                document.getElementById('memorizationStudentName').value = student.name;
                document.getElementById('memorizationDate').value = new Date().toISOString().split('T')[0];
                
                document.getElementById('addMemorizationModal').classList.remove('hidden');
            },
            
            showMemorizationReport: function(studentId) {
                const report = this.generateStudentMemorizationReport(studentId);
                if (!report) {
                    this.showMessage('الطالب غير موجود', 'danger');
                    return;
                }
                
                document.getElementById('memorizationReportStudentName').textContent = report.student.name;
                document.getElementById('memorizationReportHalaqa').textContent = report.halaqa ? report.halaqa.name : '';
                
                let reportContent = '';
                
                if (report.memorization.length === 0) {
                    reportContent = `<div class="text-center py-4"><p class="text-muted">لا يوجد تقدم مسجل للطالب</p></div>`;
                } else {
                    reportContent = `
                        <div class="mb-3">
                            <h4>إحصائيات التقدم</h4>
                            <p>إجمالي التسجيلات: ${report.totalRecords}</p>
                            <p>آخر تحديث: ${report.lastUpdate}</p>
                        </div>
                        
                        <div>
                            <h4>سجل التقدم</h4>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>النوع</th>
                                            <th>من</th>
                                            <th>إلى</th>
                                            <th>ملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    report.memorization.forEach(progress => {
                        const date = new Date(progress.date).toLocaleDateString('ar-SA');
                        reportContent += `
                            <tr>
                                <td>${date}</td>
                                <td>${this.getArabicType(progress.type)}</td>
                                <td>${progress.from}</td>
                                <td>${progress.to}</td>
                                <td>${progress.notes || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    reportContent += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('memorizationReportContent').innerHTML = reportContent;
                
                const message = this.createMemorizationReportMessage(report.student.name, report.halaqa ? report.halaqa.name : 'الحلقة', { recentProgress: report.memorization.slice(0, 3), totalProgress: { count: report.totalRecords, lastUpdate: report.lastUpdate } });
                const whatsappLink = this.createWhatsappLink(report.student.phone, message);
                document.getElementById('sendMemorizationReportBtn').href = whatsappLink;
                document.getElementById('sendMemorizationReportBtn').onclick = function(e) {
                    window.open(whatsappLink, '_blank');
                    HalaqaSystem.addActivity('whatsapp', `تم إرسال تقرير التسميع للطالب: ${report.student.name}`);
                };
                
                document.getElementById('studentMemorizationReportModal').classList.remove('hidden');
            },
            
            generateReport: function() {
                const reportType = document.getElementById('reportType').value;
                const date = document.getElementById('reportDate').value;
                const halaqaId = document.getElementById('reportHalaqa').value;
                
                const reportHalaqaSelect = document.getElementById('reportHalaqa');
                reportHalaqaSelect.innerHTML = '<option value="all">جميع الحلقات</option>';
                this.getTeacherHalaqas().forEach(halaqa => {
                    const option = document.createElement('option');
                    option.value = halaqa.id;
                    option.textContent = halaqa.name;
                    if (halaqaId && halaqa.id === parseInt(halaqaId)) option.selected = true;
                    reportHalaqaSelect.appendChild(option);
                });
                
                switch(reportType) {
                    case 'dailyAttendance': this.generateDailyAttendanceReport(date, halaqaId); break;
                    case 'studentMemorization': this.generateMemorizationReport(halaqaId); break;
                    case 'absenceReport': this.generateAbsenceReport(halaqaId); break;
                }
            },
            
            generateDailyAttendanceReport: function(date, halaqaId) {
                if (!date) { this.showMessage('الرجاء تحديد تاريخ', 'warning'); return; }
                
                const reportDate = new Date(date);
                const formattedDate = reportDate.toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                let students = this.getTeacherStudents().filter(s => !s.isFrozen);
                if (halaqaId !== 'all') students = students.filter(s => s.halaqaId === parseInt(halaqaId));
                
                const attendanceData = this.getAttendanceByDate(date);
                
                let reportHTML = `
                    <div class="report-content">
                        <div class="report-header">
                            <h2 class="report-title">تقرير الحضور اليومي</h2>
                            <p class="report-subtitle">${formattedDate}</p>
                            <p class="report-subtitle">${halaqaId === 'all' ? 'جميع الحلقات' : this.halaqas.find(h => h.id === parseInt(halaqaId))?.name}</p>
                        </div>
                        
                        <div class="report-summary">
                            <div class="summary-card"><h4>${students.length}</h4><p>إجمالي الطلاب</p></div>
                            <div class="summary-card"><h4>${attendanceData.filter(a => a.status === 'present').length}</h4><p>حاضرين</p></div>
                            <div class="summary-card"><h4>${attendanceData.filter(a => a.status === 'absent').length}</h4><p>غائبين</p></div>
                            <div class="summary-card"><h4>${students.length - attendanceData.length}</h4><p>لم يسجل</p></div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>اسم الطالب</th>
                                        <th>الحلقة</th>
                                        <th>حالة الحضور</th>
                                        <th>ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                students.forEach((student, index) => {
                    const halaqa = this.halaqas.find(h => h.id === student.halaqaId);
                    const attendance = attendanceData.find(a => a.studentId === student.id);
                    let status = 'لم يسجل';
                    let statusClass = 'status-not-recorded';
                    
                    if (attendance) {
                        status = attendance.status === 'present' ? 'حاضر' : 'غائب';
                        statusClass = attendance.status === 'present' ? 'status-present' : 'status-absent';
                    }
                    
                    reportHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${student.name}</strong></td>
                            <td>${halaqa ? halaqa.name : 'غير محدد'}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                            <td>${attendance && attendance.status === 'absent' ? 'غياب' : '-'}</td>
                        </tr>
                    `;
                });
                
                reportHTML += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4">
                            <h4>ملاحظات:</h4>
                            <p>1. هذا التقرير لا يشمل الطلاب المجمدين.</p>
                            <p>2. الطلاب الذين غابوا لمدة 3 أيام متتالية يتم تجميدهم تلقائياً.</p>
                            <p>3. نسبة الحضور: ${students.length > 0 ? Math.round((attendanceData.filter(a => a.status === 'present').length / students.length) * 100) : 0}%</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportContent').innerHTML = reportHTML;
            },
            
            generateMemorizationReport: function(halaqaId) {
                let students = this.getTeacherStudents();
                if (halaqaId !== 'all') students = students.filter(s => s.halaqaId === parseInt(halaqaId));
                
                let reportHTML = `
                    <div class="report-content">
                        <div class="report-header">
                            <h2 class="report-title">تقارير التسميع الفردية</h2>
                            <p class="report-subtitle">${halaqaId === 'all' ? 'جميع الحلقات' : this.halaqas.find(h => h.id === parseInt(halaqaId))?.name}</p>
                        </div>
                        
                        <div class="report-summary">
                            <div class="summary-card"><h4>${students.length}</h4><p>إجمالي الطلاب</p></div>
                            <div class="summary-card"><h4>${students.filter(s => this.getStudentMemorization(s.id).length > 0).length}</h4><p>طلاب مسجل تقدمهم</p></div>
                            <div class="summary-card"><h4>${students.filter(s => this.getStudentMemorization(s.id).length === 0).length}</h4><p>طلاب بدون تقدم</p></div>
                            <div class="summary-card"><h4>${this.calculateMemorizationProgress()}%</h4><p>متوسط التقدم</p></div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>اسم الطالب</th>
                                        <th>الحلقة</th>
                                        <th>عدد التسجيلات</th>
                                        <th>آخر تقدم</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                students.forEach((student, index) => {
                    const halaqa = this.halaqas.find(h => h.id === student.halaqaId);
                    const memorizationData = this.getStudentMemorization(student.id);
                    const lastProgress = memorizationData.length > 0 ? memorizationData[0] : null;
                    
                    reportHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${student.name}</strong></td>
                            <td>${halaqa ? halaqa.name : 'غير محدد'}</td>
                            <td>${memorizationData.length}</td>
                            <td>${lastProgress ? `${this.getArabicType(lastProgress.type)}: ${lastProgress.from} → ${lastProgress.to}` : 'لا يوجد'}</td>
                            <td>
                                <button class="btn btn-info btn-small" onclick="HalaqaSystem.showMemorizationReport(${student.id})">
                                    <i class="fas fa-file-alt"></i> عرض التقرير
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                reportHTML += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4">
                            <h4>تعليمات:</h4>
                            <p>1. اضغط على "عرض التقرير" لعرض تقرير مفصل لكل طالب.</p>
                            <p>2. يمكنك إرسال التقرير الفردي إلى ولي أمر الطالب عبر واتساب.</p>
                            <p>3. التسجيلات تشمل: التجويد، الحفظ، المراجعة، التلاوة.</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportContent').innerHTML = reportHTML;
            },
            
            generateAbsenceReport: function(halaqaId) {
                let students = this.getTeacherStudents().filter(s => !s.isFrozen);
                if (halaqaId !== 'all') students = students.filter(s => s.halaqaId === parseInt(halaqaId));
                
                const studentsWithAbsence = students.filter(s => this.getConsecutiveAbsenceDays(s.id) >= 2);
                
                let reportHTML = `
                    <div class="report-content">
                        <div class="report-header">
                            <h2 class="report-title">تقرير الغياب المتواصل</h2>
                            <p class="report-subtitle">${halaqaId === 'all' ? 'جميع الحلقات' : this.halaqas.find(h => h.id === parseInt(halaqaId))?.name}</p>
                        </div>
                        
                        <div class="report-summary">
                            <div class="summary-card"><h4>${students.length}</h4><p>إجمالي الطلاب النشطين</p></div>
                            <div class="summary-card"><h4>${studentsWithAbsence.length}</h4><p>طلاب لديهم غياب متواصل</p></div>
                            <div class="summary-card"><h4>${studentsWithAbsence.filter(s => this.getConsecutiveAbsenceDays(s.id) >= 3).length}</h4><p>طلاب غياب 3+ أيام</p></div>
                            <div class="summary-card"><h4>${this.getTeacherStudents().filter(s => s.isFrozen).length}</h4><p>طلاب مجمدين</p></div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>اسم الطالب</th>
                                        <th>الحلقة</th>
                                        <th>رقم ولي الأمر</th>
                                        <th>أيام غياب متتالية</th>
                                        <th>حالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                studentsWithAbsence.forEach((student, index) => {
                    const halaqa = this.halaqas.find(h => h.id === student.halaqaId);
                    const consecutiveDays = this.getConsecutiveAbsenceDays(student.id);
                    let status = '';
                    let statusClass = '';
                    
                    if (consecutiveDays >= 3) { status = 'يتطلب إجراء'; statusClass = 'status-absent'; }
                    else if (consecutiveDays === 2) { status = 'تحذير'; statusClass = 'status-not-recorded'; }
                    
                    reportHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${student.name}</strong></td>
                            <td>${halaqa ? halaqa.name : 'غير محدد'}</td>
                            <td>${this.formatPhoneForDisplay(student.phone)}</td>
                            <td>${consecutiveDays} يوم</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                            <td>
                                ${consecutiveDays >= 3 ? `
                                    <button class="btn btn-danger btn-small" onclick="HalaqaSystem.sendAbsenceWarning(${student.id})">
                                        <i class="fab fa-whatsapp"></i> إرسال إنذار
                                    </button>
                                ` : `
                                    <button class="btn btn-warning btn-small" onclick="HalaqaSystem.sendAbsenceWarning(${student.id})">
                                        <i class="fab fa-whatsapp"></i> إرسال تنبيه
                                    </button>
                                `}
                            </td>
                        </tr>
                    `;
                });
                
                if (studentsWithAbsence.length === 0) {
                    reportHTML += `<tr><td colspan="7" class="text-center"><p class="text-muted">لا يوجد طلاب لديهم غياب متواصل</p></td></tr>`;
                }
                
                reportHTML += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4">
                            <h4>تعليمات:</h4>
                            <p>1. الطلاب الذين يغيبون لمدة يومين متتاليين: إرسال تنبيه.</p>
                            <p>2. الطلاب الذين يغيبون لمدة 3 أيام متتالية: إرسال إنذار وتجميد تلقائي.</p>
                            <p>3. الطلاب المجمدين لا يظهرون في هذا التقرير.</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportContent').innerHTML = reportHTML;
            },
            
            sendAbsenceWarning: function(studentId) {
                const student = this.students.find(s => s.id === studentId);
                if (!student) return;
                
                const consecutiveDays = this.getConsecutiveAbsenceDays(studentId);
                const halaqa = this.halaqas.find(h => h.id === student.halaqaId);
                
                let message = '';
                if (consecutiveDays >= 3) {
                    message = this.create3DaysAbsenceMessage(student.name, new Date(Date.now() - (consecutiveDays * 24 * 60 * 60 * 1000)).toISOString().split('T')[0], new Date().toISOString().split('T')[0], halaqa ? halaqa.name : 'الحلقة');
                } else {
                    message = `السلام عليكم ورحمة الله وبركاته

نود إبلاغكم بأن الطالب/ة *${student.name}* لديه/ا غياب متواصل لمدة ${consecutiveDays} يوم/أيام في ${halaqa ? halaqa.name : 'الحلقة'}.

نرجو منكم التواصل معنا لمتابعة الطالب/ة.

تقبلوا تحياتنا
إدارة الحلقات التعليمية`;
                }
                
                const whatsappLink = this.createWhatsappLink(student.phone, message);
                window.open(whatsappLink, '_blank');
                
                if (consecutiveDays >= 3) {
                    this.updateStudent(student.id, student.name, student.phone, student.halaqaId, true);
                    this.addActivity('whatsapp', `تم إرسال إنذار غياب وتجميد الطالب: ${student.name}`);
                } else {
                    this.addActivity('whatsapp', `تم إرسال تنبيه غياب للطالب: ${student.name}`);
                }
                
                this.showMessage('تم فتح واتساب لإرسال الرسالة', 'success');
            },
            
            printReport: function() { window.print(); },
            
            showMessage: function(message, type) {
                const alertElement = document.createElement('div');
                alertElement.className = `alert alert-${type}`;
                alertElement.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i><span>${message}</span>`;
                
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.prepend(alertElement);
                    setTimeout(() => { alertElement.remove(); }, 5000);
                }
            },
            
            setupEventListeners: function() {
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    if (this.login(username, password)) this.showMessage('تم تسجيل الدخول بنجاح', 'success');
                    else {
                        const messageEl = document.getElementById('loginMessage');
                        messageEl.querySelector('#messageText').textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة';
                        messageEl.classList.remove('hidden');
                        setTimeout(() => { messageEl.classList.add('hidden'); }, 5000);
                    }
                });
                
                document.getElementById('registerForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fullName = document.getElementById('regFullName').value;
                    const username = document.getElementById('regUsername').value;
                    const password = document.getElementById('regPassword').value;
                    const confirmPassword = document.getElementById('regConfirmPassword').value;
                    
                    if (password.length < 6) {
                        const messageEl = document.getElementById('registerMessage');
                        messageEl.querySelector('#registerMessageText').textContent = 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
                        messageEl.classList.remove('hidden');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        const messageEl = document.getElementById('registerMessage');
                        messageEl.querySelector('#registerMessageText').textContent = 'كلمات المرور غير متطابقة';
                        messageEl.classList.remove('hidden');
                        return;
                    }
                    
                    const result = this.register(fullName, username, password);
                    if (result.success) {
                        this.currentUser = result.user;
                        localStorage.setItem('current_user', JSON.stringify(result.user));
                        this.showApp();
                        this.loadDashboard();
                        this.showMessage('تم إنشاء الحساب بنجاح', 'success');
                    } else {
                        const messageEl = document.getElementById('registerMessage');
                        messageEl.querySelector('#registerMessageText').textContent = result.message;
                        messageEl.classList.remove('hidden');
                    }
                });
                
                document.getElementById('showRegister').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('registerPage').classList.remove('hidden');
                });
                
                document.getElementById('showLogin').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('registerPage').classList.add('hidden');
                    document.getElementById('loginPage').classList.remove('hidden');
                });
                
                document.getElementById('logoutBtn').addEventListener('click', () => { this.logout(); });
                
                document.querySelectorAll('.sidebar-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        document.getElementById('sidebar').classList.remove('active');
                        const page = link.getAttribute('data-page');
                        this.showPage(page);
                    });
                });
                
                document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('active');
                });
                
                document.getElementById('addHalaqaBtn').addEventListener('click', () => {
                    document.getElementById('addHalaqaModal').classList.remove('hidden');
                });
                
                document.getElementById('closeHalaqaModal').addEventListener('click', () => {
                    document.getElementById('addHalaqaModal').classList.add('hidden');
                });
                
                document.getElementById('addHalaqaForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('halaqaName').value;
                    const description = document.getElementById('halaqaDescription').value;
                    this.addHalaqa(name, description);
                    document.getElementById('addHalaqaForm').reset();
                    document.getElementById('addHalaqaModal').classList.add('hidden');
                    this.loadHalaqasPage();
                    this.showMessage('تم إضافة الحلقة وتحديث الإحصائيات', 'success');
                });
                
                document.getElementById('addStudentBtn').addEventListener('click', () => {
                    const halaqaSelect = document.getElementById('studentHalaqa');
                    halaqaSelect.innerHTML = '<option value="">اختر الحلقة</option>';
                    this.getTeacherHalaqas().forEach(halaqa => {
                        const option = document.createElement('option');
                        option.value = halaqa.id;
                        option.textContent = halaqa.name;
                        halaqaSelect.appendChild(option);
                    });
                    document.getElementById('addStudentModal').classList.remove('hidden');
                });
                
                document.getElementById('closeStudentModal').addEventListener('click', () => {
                    document.getElementById('addStudentModal').classList.add('hidden');
                });
                
                document.getElementById('studentPhone').addEventListener('input', function() {
                    const phone = this.value;
                    const validationHint = document.getElementById('phoneValidation');
                    const isValid = HalaqaSystem.validateYemeniPhone(phone);
                    
                    if (phone.length === 0) {
                        validationHint.className = 'validation-hint';
                        validationHint.innerHTML = '<i class="fas fa-info-circle"></i><span>يجب أن يبدأ الرقم بـ 7 ويتكون من 9 أرقام (مثال: 712345678)</span>';
                    } else if (isValid) {
                        validationHint.className = 'validation-hint valid';
                        validationHint.innerHTML = '<i class="fas fa-check-circle"></i><span>رقم هاتف يمني صحيح</span>';
                    } else {
                        validationHint.className = 'validation-hint invalid';
                        validationHint.innerHTML = '<i class="fas fa-times-circle"></i><span>رقم هاتف غير صحيح. يجب أن يبدأ بـ 7 ويتكون من 9 أرقام</span>';
                    }
                });
                
                document.getElementById('addStudentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('studentName').value;
                    const phone = document.getElementById('studentPhone').value;
                    const halaqaId = document.getElementById('studentHalaqa').value;
                    
                    if (!this.validateYemeniPhone(phone)) {
                        this.showMessage('رقم الهاتف غير صحيح. يجب أن يكون رقم يمني يبدأ بـ 7 ويتكون من 9 أرقام', 'danger');
                        return;
                    }
                    
                    const result = this.addStudent(name, phone, halaqaId);
                    if (result.success) {
                        document.getElementById('addStudentForm').reset();
                        document.getElementById('addStudentModal').classList.add('hidden');
                        this.loadStudentsPage();
                        this.showMessage('تم إضافة الطالب وتحديث الإحصائيات', 'success');
                    } else this.showMessage(result.message, 'danger');
                });
                
                document.getElementById('editStudentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = document.getElementById('editStudentId').value;
                    const name = document.getElementById('editStudentName').value;
                    const phone = document.getElementById('editStudentPhone').value;
                    const halaqaId = document.getElementById('editStudentHalaqa').value;
                    const isFrozen = document.getElementById('editStudentFrozen').checked;
                    
                    const result = this.updateStudent(parseInt(id), name, phone, halaqaId, isFrozen);
                    if (result.success) {
                        document.getElementById('editStudentModal').classList.add('hidden');
                        this.loadStudentsPage();
                        this.showMessage('تم تحديث بيانات الطالب بنجاح', 'success');
                    } else this.showMessage(result.message, 'danger');
                });
                
                document.getElementById('closeEditStudentModal').addEventListener('click', () => {
                    document.getElementById('editStudentModal').classList.add('hidden');
                });
                
                document.getElementById('editStudentPhone').addEventListener('input', function() {
                    const phone = this.value;
                    const validationHint = document.getElementById('editPhoneValidation');
                    const isValid = HalaqaSystem.validateYemeniPhone(phone);
                    
                    if (phone.length === 0) {
                        validationHint.className = 'validation-hint';
                        validationHint.innerHTML = '<i class="fas fa-info-circle"></i><span>يجب أن يبدأ الرقم بـ 7 ويتكون من 9 أرقام (مثال: 712345678)</span>';
                    } else if (isValid) {
                        validationHint.className = 'validation-hint valid';
                        validationHint.innerHTML = '<i class="fas fa-check-circle"></i><span>رقم هاتف يمني صحيح</span>';
                    } else {
                        validationHint.className = 'validation-hint invalid';
                        validationHint.innerHTML = '<i class="fas fa-times-circle"></i><span>رقم هاتف غير صحيح. يجب أن يبدأ بـ 7 ويتكون من 9 أرقام</span>';
                    }
                });
                
                document.getElementById('addMemorizationBtn').addEventListener('click', () => {
                    this.showPage('students');
                    this.showMessage('الرجاء اختيار طالب لتسجيل تقدمه من صفحة الطلاب', 'info');
                });
                
                document.getElementById('addMemorizationForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const studentId = parseInt(document.getElementById('memorizationStudentId').value);
                    const type = document.getElementById('memorizationType').value;
                    const from = document.getElementById('memorizationFrom').value;
                    const to = document.getElementById('memorizationTo').value;
                    const notes = document.getElementById('memorizationNotes').value;
                    const date = document.getElementById('memorizationDate').value;
                    
                    const result = this.addMemorizationProgress(studentId, type, from, to, notes, date);
                    if (result.success) {
                        document.getElementById('addMemorizationForm').reset();
                        document.getElementById('addMemorizationModal').classList.add('hidden');
                        this.loadMemorizationPage();
                        this.showMessage('تم تسجيل تقدم التسميع بنجاح', 'success');
                    }
                });
                
                document.getElementById('closeMemorizationModal').addEventListener('click', () => {
                    document.getElementById('addMemorizationModal').classList.add('hidden');
                });
                
                document.getElementById('saveAttendanceBtn').addEventListener('click', () => {
                    this.showMessage('تم حفظ الحضور بنجاح', 'success');
                    this.loadDashboard();
                });
                
                document.getElementById('markAllPresentBtn').addEventListener('click', () => {
                    const date = document.getElementById('attendanceDate').value;
                    const students = this.getTeacherStudents().filter(s => !s.isFrozen);
                    students.forEach(student => { this.markAttendance(student.id, date, 'present'); });
                    this.loadAttendancePage();
                    this.showMessage('تم تعيين جميع الطلاب كحاضرين', 'success');
                });
                
                document.getElementById('halaqaFilter').addEventListener('change', () => { this.loadAttendancePage(); });
                document.getElementById('attendanceDate').addEventListener('change', () => { this.loadAttendancePage(); });
                document.getElementById('showFrozenStudents').addEventListener('change', () => { this.loadAttendancePage(); });
                document.getElementById('memorizationHalaqaFilter').addEventListener('change', (e) => { this.loadMemorizationStudents(e.target.value); });
                
                document.getElementById('closeWhatsapp3DaysModal').addEventListener('click', () => { document.getElementById('whatsappAbsence3DaysModal').classList.add('hidden'); });
                document.getElementById('cancelWhatsapp3DaysBtn').addEventListener('click', () => { document.getElementById('whatsappAbsence3DaysModal').classList.add('hidden'); });
                document.getElementById('closeStudentMemorizationModal').addEventListener('click', () => { document.getElementById('studentMemorizationReportModal').classList.add('hidden'); });
                document.getElementById('printMemorizationReportBtn').addEventListener('click', () => { window.print(); });
                
                document.getElementById('checkAbsenceBtn').addEventListener('click', () => { this.checkAllHalaqasAbsence(); });
                document.getElementById('bulkAbsenceDate').addEventListener('change', () => { this.checkAllHalaqasAbsence(); });
                
                document.getElementById('closeBulkModal').addEventListener('click', () => { document.getElementById('bulkWhatsappModal').classList.add('hidden'); });
                document.getElementById('cancelBulkBtn').addEventListener('click', () => { document.getElementById('bulkWhatsappModal').classList.add('hidden'); });
                document.getElementById('sendBulkToGroupBtn').addEventListener('click', () => { this.sendBulkToGroup(); });
                document.getElementById('sendBulkToParentsBtn').addEventListener('click', () => { this.sendBulkToParents(); });
                
                document.getElementById('generateReportBtn').addEventListener('click', () => { this.generateReport(); });
                document.getElementById('printReportBtn').addEventListener('click', () => { this.printReport(); });
                
                document.getElementById('dashboardSearch').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const activityItems = document.querySelectorAll('.activity-item');
                    activityItems.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        item.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
                document.getElementById('searchStudents').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#studentsTableBody tr');
                    rows.forEach(row => { row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none'; });
                });
                
                document.querySelectorAll('.toggle-password').forEach(button => {
                    button.addEventListener('click', function() {
                        const input = this.previousElementSibling;
                        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                        input.setAttribute('type', type);
                        const icon = this.querySelector('i');
                        icon.className = type === 'password' ? 'far fa-eye' : 'far fa-eye-slash';
                    });
                });
                
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', function(e) { if (e.target === this) this.classList.add('hidden'); });
                });
                
                setTimeout(() => { if (document.getElementById('bulkAbsenceDate')) this.checkAllHalaqasAbsence(); }, 500);
            },
            
            showLogin: function() {
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('registerPage').classList.add('hidden');
                document.getElementById('app').classList.add('hidden');
            },
            
            showApp: function() {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('registerPage').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                if (this.currentUser) {
                    const firstLetter = this.currentUser.fullName.charAt(0);
                    document.getElementById('userAvatar').textContent = firstLetter;
                    document.getElementById('currentUserName').textContent = this.currentUser.fullName;
                }
            },
            
            showPage: function(pageName) {
                document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
                document.getElementById(`${pageName}Page`).classList.remove('hidden');
                
                switch(pageName) {
                    case 'dashboard': this.loadDashboard(); break;
                    case 'halaqas': this.loadHalaqasPage(); break;
                    case 'students': this.loadStudentsPage(); break;
                    case 'attendance': this.loadAttendancePage(); break;
                    case 'memorization': this.loadMemorizationPage(); break;
                    case 'reports': 
                        const reportDate = document.getElementById('reportDate');
                        if (!reportDate.value) reportDate.value = new Date().toISOString().split('T')[0];
                        break;
                }
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() { HalaqaSystem.init(); });
    </script>
</body>
</html>